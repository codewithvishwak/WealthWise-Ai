<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WealthWise AI - Emphasizes Intelligent Financial Decisions</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #a855f7;
            --secondary-color: #6366f1;
            --success-color: #10b981;
            --danger-color: #f43f5e;
            --warning-color: #fbbf24;
            --dark-bg: #0a0a1f;
            --light-bg: #090a0f;
            --card-bg: rgba(15, 10, 40, 0.85);
            --text-primary: #f1f5f9;
            --text-secondary: #a5b4fc;
            --border-color: rgba(168, 85, 247, 0.3);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 30px rgba(168, 85, 247, 0.2);
            --glow-purple: 0 0 30px rgba(168, 85, 247, 0.4);
            --glow-cyan: 0 0 30px rgba(34, 211, 238, 0.4);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            color: var(--text-primary);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(168, 85, 247, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 50%, rgba(34, 211, 238, 0.05) 0%, transparent 60%);
            pointer-events: none;
            z-index: -1;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(1px 1px at 20px 30px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 80px 70px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 150px 40px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 220px 120px, rgba(168, 85, 247, 0.8), transparent),
                radial-gradient(1px 1px at 300px 80px, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 380px 200px, rgba(34, 211, 238, 0.7), transparent),
                radial-gradient(1px 1px at 460px 150px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 550px 60px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 650px 180px, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 750px 100px, rgba(168, 85, 247, 0.6), transparent);
            background-size: 800px 400px;
            pointer-events: none;
            animation: starsFloat 150s linear infinite;
            z-index: -1;
        }

        @keyframes starsFloat {
            from { transform: translateY(0); }
            to { transform: translateY(-400px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(400px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(1000px) rotate(720deg); opacity: 0; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.7), 0 0 60px rgba(34, 211, 238, 0.3); }
        }

        .fade-in { animation: fadeIn 0.6s ease-out; }
        .slide-up { animation: slideUp 0.4s ease-out; }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            min-width: 260px;
            max-width: 260px;
            background: linear-gradient(180deg, #0a0a1f 0%, #1a1040 100%);
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            border-right: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 5px 0 30px rgba(168, 85, 247, 0.1);
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.3);
            border-radius: 3px;
        }

        .sidebar-header {
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 1.5em;
            background: linear-gradient(135deg, #a855f7, #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
            white-space: nowrap;
        }

        .sidebar-header p {
            font-size: 0.85em;
            color: #94a3b8;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-level-card {
            background: linear-gradient(135deg, #a855f7, #22d3ee);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            animation: glow 3s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
        }

        .user-level-card h3 {
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .user-level-card .level-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 10px;
            display: inline-block;
        }

        .xp-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .xp-progress {
            background: white;
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .xp-text {
            font-size: 0.8em;
            margin-top: 5px;
            opacity: 0.9;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: #a5b4fc;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
        }

        .nav-item span:first-child {
            width: 24px;
            min-width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(168, 85, 247, 0.25);
            color: white;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger-color);
            color: white;
            font-size: 0.65em;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
            background: transparent;
            min-height: 100vh;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .dashboard-header h1 {
            font-size: 2em;
            color: #f1f5f9;
            text-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            padding: 10px 20px;
            border: 2px solid rgba(168, 85, 247, 0.5);
            background: rgba(15, 10, 40, 0.8);
            color: #a5b4fc;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.5);
        }

        .btn-export {
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(15, 10, 40, 0.85);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s ease;
            border: 1px solid rgba(168, 85, 247, 0.25);
            backdrop-filter: blur(10px);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.3);
            border-color: var(--primary-color);
        }

        .stat-icon { font-size: 3em; }

        .stat-info h3 {
            color: #a5b4fc;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #22d3ee;
            transition: color 0.3s ease;
            text-shadow: 0 0 15px rgba(34, 211, 238, 0.4);
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .prediction-card {
            background: linear-gradient(135deg, #a855f7, #22d3ee);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.4);
            position: relative;
            overflow: hidden;
        }

        .prediction-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        .prediction-card h3 {
            font-size: 1em;
            margin-bottom: 15px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .prediction-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .prediction-insight {
            font-size: 0.9em;
            opacity: 0.8;
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        .prediction-trend {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            position: relative;
            z-index: 1;
        }

        .trend-up {
            color: #fca5a5;
        }

        .trend-down {
            color: #86efac;
        }

        .achievements-section {
            margin-bottom: 30px;
        }

        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .achievement-badge {
            background: rgba(15, 10, 40, 0.85);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            border: 1px solid rgba(168, 85, 247, 0.25);
        }

        .achievement-badge:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.3);
            border-color: var(--primary-color);
        }

        .achievement-badge.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .achievement-badge.unlocked {
            animation: pulse 0.5s ease;
        }

        .achievement-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .achievement-name {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #f1f5f9;
        }

        .achievement-desc {
            font-size: 0.75em;
            color: #a5b4fc;
            line-height: 1.3;
        }

        .achievement-xp {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #a855f7, #22d3ee);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
        }

        .challenges-grid {
            display: grid;
            gap: 15px;
        }

        .challenge-card {
            background: rgba(15, 10, 40, 0.85);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
            transition: all 0.3s ease;
            border-top: 1px solid rgba(168, 85, 247, 0.2);
            border-right: 1px solid rgba(168, 85, 247, 0.2);
            border-bottom: 1px solid rgba(168, 85, 247, 0.2);
        }

        .challenge-card:hover {
            transform: translateX(5px);
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.3);
        }


        .challenge-card.active {
            border-left-color: var(--success-color);
            background: linear-gradient(to right, #f0fdf4, white);
        }

        .challenge-card.completed {
            border-left-color: #10b981;
            background: linear-gradient(to right, #d1fae5, white);
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .challenge-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .challenge-reward {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .challenge-desc {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .challenge-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar {
            flex: 1;
            background: #e5e7eb;
            height: 10px;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 60px;
            text-align: right;
        }

        .challenge-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-challenge {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-start {
            background: var(--primary-color);
            color: white;
        }

        .btn-start:hover {
            background: var(--secondary-color);
        }

        .btn-complete {
            background: var(--success-color);
            color: white;
        }

        .streak-container {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .streak-value {
            font-size: 3em;
            font-weight: 700;
            margin: 10px 0;
        }

        .streak-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .leaderboard-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-secondary);
            min-width: 40px;
        }

        .leaderboard-rank.top-1 {
            color: #fbbf24;
        }

        .leaderboard-rank.top-2 {
            color: #9ca3af;
        }

        .leaderboard-rank.top-3 {
            color: #cd7f32;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .leaderboard-score {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .leaderboard-points {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .chart-container {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .chart-container canvas {
            max-height: 350px !important;
            height: 350px !important;
        }

        .chart-container h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chart-controls { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap;
        }

        .chart-btn {
            padding: 8px 15px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .chart-btn.active, .chart-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .content-section { display: none; }
        .content-section.active { display: block; }

        .expenses-list, .budgets-list, .recommendations-list {
            display: grid;
            gap: 15px;
        }

        .expense-item, .budget-item {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
        }

        .expense-info, .budget-info { flex: 1; }

        .expense-info h3, .budget-info h3 {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .expense-meta, .budget-meta {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .expense-amount {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .priority-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
            text-transform: capitalize;
        }

        .priority-most_important { background: #fee2e2; color: var(--danger-color); }
        .priority-important { background: #fed7aa; color: var(--warning-color); }
        .priority-less_important { background: #dbeafe; color: #3b82f6; }
        .priority-least_important { background: #e5e7eb; color: var(--text-secondary); }

        .recommendation-item {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
            animation: fadeIn 0.5s ease-out;
        }

        .recommendation-item p {
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .savings-badge {
            background: #d1fae5;
            color: var(--success-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            display: inline-block;
        }

        .btn-insight-action {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-insight-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .section-header {
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .section-header h3 {
            color: var(--text-primary);
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            position: relative;
            box-shadow: var(--shadow-lg);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .close:hover { color: var(--danger-color); }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .budget-alert {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-left: 5px solid;
            animation: slideInRight 0.4s ease-out;
            max-width: 400px;
        }

        .budget-alert-danger {
            border-left-color: #ef4444;
            background: linear-gradient(to right, #fef2f2, white);
        }

        .budget-alert-warning {
            border-left-color: #f59e0b;
            background: linear-gradient(to right, #fffbeb, white);
        }

        .budget-alert-info {
            border-left-color: #3b82f6;
            background: linear-gradient(to right, #eff6ff, white);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .alert-header strong {
            color: var(--text-primary);
            font-size: 1em;
            flex: 1;
        }

        .alert-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .alert-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        .alert-body {
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.5;
        }

        .export-modal-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .export-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .export-option:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }

        .export-option-icon {
            font-size: 2em;
        }

        .export-option-info h3 {
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .export-option-info p {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 9999;
            animation: confetti 3s ease-out forwards;
        }

        .help-container, .about-container {
            display: grid;
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .help-card, .about-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease-out;
        }

        .help-card h3, .about-card h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .help-card p, .about-card p {
            line-height: 1.7;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .help-card ul, .help-card ol, .about-card ul {
            margin-left: 20px;
            line-height: 1.8;
            color: var(--text-primary);
        }

        .about-hero {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; }
            .predictions-grid { grid-template-columns: 1fr; }
            .achievements-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                flex-direction: column;
            }

            .header-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üß†WealthWise Ai</h2>
                <p>Emphasizes Intelligent Financial Decisions</p>
            </div>

            <div class="user-level-card">
                <div class="level-badge" id="userLevel">Level 1 - Beginner</div>
                <h3 id="userXP">0 XP</h3>
                <div class="xp-bar">
                    <div class="xp-progress" id="xpProgress" style="width: 0%"></div>
                </div>
                <p class="xp-text" id="xpText">0 / 100 XP to next level</p>
            </div>
            
            <nav class="sidebar-nav">
                <a class="nav-item active" data-section="overview">
                    <span>üìä</span> Overview
                </a>
                <a class="nav-item" data-section="predictions">
                    <span>üîÆ</span> AI Predictions
                </a>
                <a class="nav-item" data-section="recommendations">
                    <span>ü§ñ</span> AI Recommendations
                    <span class="nav-badge" id="newRecommendationsBadge" style="display: none;">NEW</span>
                </a>
                <a class="nav-item" data-section="gamification">
                    <span>üéÆ</span> Achievements
                    <span class="nav-badge" id="newAchievementsBadge" style="display: none;">NEW</span>
                </a>
                <a class="nav-item" data-section="challenges">
                    <span>üèÜ</span> Challenges
                </a>
                <a class="nav-item" data-section="expenses">
                    <span>üí∏</span> Expenses
                </a>
                <a class="nav-item" data-section="budgets">
                    <span>üéØ</span> Budgets
                </a>
                <a class="nav-item" data-section="help">
                    <span>‚ùì</span> Help
                </a>
                <a class="nav-item" data-section="about">
                    <span>‚ÑπÔ∏è</span> About
                </a>
                <a class="nav-item" id="logout">
                    <span>üö™</span> Logout
                </a>
            </nav>
        </aside>
        
        <main class="main-content">
            <header class="dashboard-header">
                <h1 id="greeting">Welcome!</h1>
                <div class="header-actions">
                    <button class="btn-secondary" id="addExpenseBtn">+ Add Expense</button>
                    <button class="btn-secondary" id="setBudgetBtn">‚öôÔ∏è Set Budget</button>
                    <button class="btn-export" id="exportBtn">üì• Export to Excel</button>
                </div>
            </header>
            
            <!-- Overview Section -->
            <section id="overview-section" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card fade-in">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-info">
                            <h3>Total Spent</h3>
                            <p class="stat-value" id="totalSpent">‚Çπ0</p>
                        </div>
                    </div>
                    
                    <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-info">
                            <h3>This Month</h3>
                            <p class="stat-value" id="monthlySpent">‚Çπ0</p>
                        </div>
                    </div>
                    
                    <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-info">
                            <h3>Transactions</h3>
                            <p class="stat-value" id="transactionCount">0</p>
                        </div>
                    </div>
                    
                    <div class="stat-card fade-in" style="animation-delay: 0.3s;">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-info">
                            <h3>Budget Left</h3>
                            <p class="stat-value" id="budgetLeft">‚Çπ0</p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h2>Expense Trends</h2>
                        <div class="chart-controls">
                            <button class="chart-btn active" data-timeframe="weekly">Week</button>
                            <button class="chart-btn" data-timeframe="monthly">Month</button>
                            <button class="chart-btn" data-timeframe="yearly">Year</button>
                        </div>
                    </div>
                    <canvas id="expenseChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h2>Spending by Category</h2>
                    <canvas id="categoryChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h2>Spending by Priority (AI Classified)</h2>
                    <canvas id="priorityChart"></canvas>
                </div>
            </section>

            <!-- Predictions Section -->
            <section id="predictions-section" class="content-section">
                <h2 style="margin-bottom: 20px;">üîÆ AI Predictive Analytics</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px; line-height: 1.6;">
                    Advanced machine learning models analyze your spending patterns to forecast future expenses and identify potential budget risks.
                </p>
                
                <div class="predictions-grid" id="predictionsGrid">
                </div>

                <div class="chart-container">
                    <h2>Predicted vs Actual Spending</h2>
                    <canvas id="predictionChart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>Spending Pattern Analysis</h2>
                    <canvas id="patternChart"></canvas>
                </div>
            </section>

            <!-- Recommendations Section -->
            <section id="recommendations-section" class="content-section">
                <h2>ü§ñ AI-Powered Recommendations</h2>
                <div id="recommendationsList" class="recommendations-list"></div>
            </section>

            <!-- Gamification Section -->
            <section id="gamification-section" class="content-section">
                <div class="achievements-section">
                    <div class="achievements-header">
                        <h2>üèÜ Your Achievements</h2>
                        <p style="color: var(--text-secondary);">Unlock badges by completing challenges!</p>
                    </div>

                    <div class="streak-container">
                        <p class="streak-label">üî• Current Streak</p>
                        <p class="streak-value" id="currentStreak">0</p>
                        <p class="streak-label">Days Under Budget</p>
                    </div>

                    <div class="achievements-grid" id="achievementsGrid">
                    </div>
                </div>

                <div class="leaderboard-card">
                    <h2 style="margin-bottom: 20px;">üëë Leaderboard (This Month)</h2>
                    <div id="leaderboardList">
                    </div>
                </div>
            </section>

            <!-- Challenges Section -->
            <section id="challenges-section" class="content-section">
                <h2 style="margin-bottom: 20px;">üèÜ Financial Challenges</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    Complete challenges to earn XP, unlock achievements, and improve your financial health!
                </p>

                <div class="challenges-grid" id="challengesGrid">
                </div>
            </section>
            
            <!-- Expenses Section -->
            <section id="expenses-section" class="content-section">
                <h2>Recent Expenses</h2>
                <div id="expensesList" class="expenses-list"></div>
            </section>
            
            <!-- Budgets Section -->
            <section id="budgets-section" class="content-section">
                <h2>Budget Goals</h2>
                <div id="budgetsList" class="budgets-list"></div>
            </section>

            <!-- Help Section -->
            <section id="help-section" class="content-section">
                <h2>‚ùì Help & Support</h2>
                
                <div class="help-container">
                    <div class="help-card">
                        <h3>üöÄ Getting Started</h3>
                        <ol>
                            <li>Click <strong>"+ Add Expense"</strong> to track your first transaction</li>
                            <li>Set a <strong>monthly budget</strong> to enable AI predictions</li>
                            <li>Track expenses for 2-3 weeks for accurate AI insights</li>
                            <li>Complete challenges to earn XP and unlock achievements</li>
                        </ol>
                    </div>

                    <div class="help-card">
                        <h3>üß† AI Features Explained</h3>
                        <p><strong>üéØ Smart Classification:</strong> Our AI automatically categorizes every expense into 4 priority levels based on urgency, necessity, and spending patterns.</p>
                        <p><strong>üîÆ Predictive Analytics:</strong> Machine learning models analyze your spending history to forecast next month's expenses with 75-90% accuracy.</p>
                        <p><strong>ü§ñ Personalized Recommendations:</strong> Get actionable tips to reduce spending, save money, and improve financial health.</p>
                    </div>

                    <div class="help-card">
                        <h3>üéÆ Gamification System</h3>
                        <p><strong>XP & Levels:</strong> Earn experience points by tracking expenses, setting budgets, and completing challenges. Level up from Beginner to Legend!</p>
                        <p><strong>Achievements:</strong> Unlock 15+ badges by hitting milestones (e.g., 10 expenses tracked, stay under budget for 7 days)</p>
                        <p><strong>Challenges:</strong> Complete weekly/monthly financial goals to earn bonus XP and build healthy money habits.</p>
                    </div>

                    <div class="help-card">
                        <h3>üìä Priority Classification</h3>
                        <ul>
                            <li><span style="color: #ef4444;">üî¥ Most Important:</span> Medical emergencies, rent, utilities</li>
                            <li><span style="color: #f59e0b;">üü† Important:</span> Education, transport, groceries</li>
                            <li><span style="color: #3b82f6;">üîµ Less Important:</span> Regular shopping, subscriptions</li>
                            <li><span style="color: #64748b;">‚ö™ Least Important:</span> Entertainment, luxury items</li>
                        </ul>
                    </div>

                    <div class="help-card">
                        <h3>üì• Export & Reports</h3>
                        <p>Download your financial data as Excel files:</p>
                        <ul>
                            <li><strong>Full Report:</strong> Complete analysis with charts & trends</li>
                            <li><strong>Monthly Breakdown:</strong> Current month category-wise expenses</li>
                            <li><strong>Weekly Summary:</strong> Last 7 days spending patterns</li>
                            <li><strong>Budget Analysis:</strong> Budget vs actual comparison</li>
                        </ul>
                    </div>

                    <div class="help-card">
                        <h3>‚ùì Frequently Asked Questions</h3>
                        <p><strong>Q: How accurate are the predictions?</strong><br>
                        A: Predictions improve with data. After 3 weeks of tracking, accuracy reaches 75-90%.</p>
                        
                        <p><strong>Q: Is my financial data secure?</strong><br>
                        A: Yes! We use Firebase's encrypted cloud storage with authentication. Your data is private and safe.</p>
                        
                        <p><strong>Q: Can I delete or edit expenses?</strong><br>
                        A: Currently you can view expenses. Edit/delete features coming in v2.0!</p>
                        
                        <p><strong>Q: What happens to my XP if I don't log in?</strong><br>
                        A: Your XP and achievements are permanently saved. You can continue anytime!</p>
                    </div>

                    <div class="help-card">
                        <h3>üìß Contact Support</h3>
                        <p>Need help? Found a bug? Have suggestions?</p>
                        <p><strong>Email:</strong> support@wealthwiseai.com</p>
                        <p><strong>GitHub:</strong> github.com/yourusername/wealthwise-ai</p>
                        <p><strong>Response Time:</strong> Within 24 hours</p>
                    </div>
                </div>
            </section>

            <!-- About Section -->
            <section id="about-section" class="content-section">
                <h2>‚ÑπÔ∏è About WealthWise AI</h2>
                
                <div class="about-container">
                    <div class="about-hero">
                        <h1 style="font-size: 2.5em; margin-bottom: 10px;">üß† WealthWise AI</h1>
                        <p style="font-size: 1.2em; color: rgba(255,255,255,0.9);">Intelligent Financial Decisions for Everyone</p>
                    </div>

                    <div class="about-card">
                        <h3>üéØ Our Mission</h3>
                        <p>WealthWise AI empowers students, young professionals, and everyday people to take control of their finances through cutting-edge AI technology and behavioral psychology.</p>
                        <p>We believe financial literacy should be accessible, engaging, and personalized ‚Äî not boring spreadsheets and complex jargon.</p>
                    </div>

                    <div class="about-card">
                        <h3>üìñ Our Story</h3>
                        <p>Built by passionate engineering students who understand the challenges of managing finances in today's world.</p>
                        <p>We witnessed how financial mismanagement affects families, especially in areas where budgeting education is minimal. WealthWise AI is our solution ‚Äî combining AI, gamification, and predictive analytics to make money management intuitive and fun.</p>
                    </div>

                    <div class="about-card">
                        <h3>‚ö° Technology Stack</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div style="padding: 15px; background: #525352; border-radius: 10px;">
                                <strong>üß† AI Engine</strong><br>
                                <small>Machine Learning Classification & Predictions</small>
                            </div>
                            <div style="padding: 15px; background: #525352; border-radius: 10px;">
                                <strong>üî• Firebase</strong><br>
                                <small>Real-time Database & Authentication</small>
                            </div>
                            <div style="padding: 15px; background: #525352; border-radius: 10px;">
                                <strong>üìä Chart.js</strong><br>
                                <small>Interactive Data Visualization</small>
                            </div>
                            <div style="padding: 15px; background: #525352; border-radius: 10px;">
                                <strong>üéÆ Gamification</strong><br>
                                <small>Custom XP, Achievements & Challenges System</small>
                            </div>
                        </div>
                    </div>

                    <div class="about-card">
                        <h3>‚ú® Key Features</h3>
                        <ul style="columns: 2; column-gap: 30px;">
                            <li>AI-Powered Expense Classification</li>
                            <li>Predictive Spending Forecasts</li>
                            <li>Smart Budget Alerts</li>
                            <li>Personalized Recommendations</li>
                            <li>Gamification & Achievements</li>
                            <li>Financial Challenges</li>
                            <li>Excel Report Generation</li>
                            <li>Real-time Synchronization</li>
                            <li>Multi-timeframe Analysis</li>
                            <li>Category & Priority Insights</li>
                        </ul>
                    </div>

                    <div class="about-card">
                        <h3>üöÄ Roadmap (Coming Soon)</h3>
                        <ul>
                            <li>‚úÖ v1.0 - Core Features (Current Version)</li>
                            <li>‚è≥ v1.5 - Edit/Delete Expenses, Multi-currency Support</li>
                            <li>‚è≥ v2.0 - Mobile App (Android), Bill Reminders</li>
                            <li>‚è≥ v2.5 - Investment Tracking, Crypto Integration</li>
                            <li>‚è≥ v3.0 - AI Chatbot Assistant, Voice Commands</li>
                        </ul>
                    </div>

                    <div class="about-card" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
                        <h3 style="color: white;">üí° Why WealthWise AI?</h3>
                        <p><strong>"Because financial freedom starts with awareness."</strong></p>
                        <p>Unlike traditional expense trackers, we use AI to understand your behavior, predict future trends, and guide you toward better decisions ‚Äî all while making it fun with gamification.</p>
                    </div>

                    <div class="about-footer" style="text-align: center; padding: 40px 20px; margin-top: 30px; border-top: 2px solid var(--border-color);">
                        <p style="font-size: 1.1em; margin-bottom: 10px;">Built with ‚ù§Ô∏è in India üáÆüá≥</p>
                        <p style="color: var(--text-secondary);">Version 1.0.0 | January 2026</p>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content slide-up">
            <span class="close">&times;</span>
            <h2>Add New Expense</h2>
            <form id="expenseForm">
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="expDescription" placeholder="e.g., Grocery shopping" required>
                </div>
                <div class="form-group">
                    <label>Amount (‚Çπ)</label>
                    <input type="number" id="expAmount" step="0.01" placeholder="e.g., 500" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" id="expCategory" list="categoryOptions" placeholder="Select or type custom category" required>
                    <datalist id="categoryOptions">
                        <option value="Food & Groceries">
                        <option value="Transport">
                        <option value="Utilities">
                        <option value="Entertainment">
                        <option value="Shopping">
                        <option value="Medical">
                        <option value="Education">
                        <option value="Rent">
                        <option value="Subscription">
                        <option value="Investment">
                        <option value="Other">
                    </datalist>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="expDate" required>
                </div>
                <button type="submit" class="btn-primary" id="submitExpenseBtn">Add Expense</button>
            </form>
        </div>
    </div>
    
    <!-- Budget Modal -->
    <div id="budgetModal" class="modal">
        <div class="modal-content slide-up">
            <span class="close">&times;</span>
            <h2>Set Budget Goal</h2>
            <form id="budgetForm">
                <div class="form-group">
                    <label>Amount (‚Çπ)</label>
                    <input type="number" id="budgetAmount" step="0.01" placeholder="e.g., 20000" required>
                </div>
                <div class="form-group">
                    <label>Timeframe</label>
                    <select id="budgetTimeframe" required>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="budgetCategory" required>
                        <option value="General">General (All Categories)</option>
                        <option value="Food & Groceries">Food & Groceries</option>
                        <option value="Transport">Transport</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary" id="submitBudgetBtn">Set Budget</button>
            </form>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content slide-up">
            <span class="close">&times;</span>
            <h2>Export Data</h2>
            <div class="export-modal-content">
                <div class="export-option" data-type="full">
                    <div class="export-option-icon">üìä</div>
                    <div class="export-option-info">
                        <h3>Complete Financial Report</h3>
                        <p>All expenses, budgets, analytics & charts</p>
                    </div>
                </div>
                <div class="export-option" data-type="monthly">
                    <div class="export-option-icon">üìÖ</div>
                    <div class="export-option-info">
                        <h3>Monthly Breakdown</h3>
                        <p>Current month expenses by category & priority</p>
                    </div>
                </div>
                <div class="export-option" data-type="weekly">
                    <div class="export-option-icon">üìÜ</div>
                    <div class="export-option-info">
                        <h3>Weekly Summary</h3>
                        <p>Last 7 days expenses & spending patterns</p>
                    </div>
                </div>
                <div class="export-option" data-type="budget">
                    <div class="export-option-icon">üéØ</div>
                    <div class="export-option-info">
                        <h3>Budget Analysis</h3>
                        <p>Budget goals vs actual spending</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, push, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyA3PFNIhXjyRyVtDagpVACoGjFDMVkWPzo",
        authDomain: "expense-tracker-app-9f58b.firebaseapp.com",
        databaseURL: "https://expense-tracker-app-9f58b-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "expense-tracker-app-9f58b",
        storageBucket: "expense-tracker-app-9f58b.firebasestorage.app",
        messagingSenderId: "292372924041",
        appId: "1:292372924041:web:1464cf450ed215260fa858"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // ‚úÖ IMPROVED AI Classification Engine
    class ExpenseClassifier {
        classifyExpense(amount, category, description) {
            const features = this.extractFeatures(amount, category, description);
            return this.advancedClassification(features);
        }
        
        extractFeatures(amount, category, description) {
            const descLower = description.toLowerCase();
            const categoryLower = category.toLowerCase();
            
            return {
                amount: parseFloat(amount),
                category: categoryLower,
                description: descLower,
                
                // MOST IMPORTANT (Life-critical)
                isEmergency: /emergency|urgent|critical|immediate|asap|911|hospital emergency|accident|crisis/.test(descLower),
                isMedical: /medical|doctor|hospital|medicine|health|prescription|clinic|surgery|ambulance|pharmacy|dentist|x-ray|mri|ct scan|emergency room|er visit|blood test|vaccine|injection|operation|icu/.test(descLower) || categoryLower === 'medical',
                isRent: /rent|lease|mortgage|house payment|housing|landlord/.test(descLower) || categoryLower === 'rent',
                isUtility: /electricity|water|gas|internet|phone|mobile|wifi|broadband|telephone|heating|cooling|sewage|trash|garbage|electricity bill|water bill/.test(descLower) || categoryLower === 'utilities',
                
                // IMPORTANT (Necessary)
                isFood: /food|grocery|groceries|meal|vegetables|fruits|market|supermarket|provisions|ration|staples|milk|bread|rice|wheat|dal|cooking|kitchen/.test(descLower) || categoryLower.includes('food') || categoryLower.includes('groceries'),
                isTransport: /transport|fuel|petrol|diesel|bus|train|taxi|uber|ola|metro|auto|rickshaw|cab|commute|travel pass|monthly pass|bike|car maintenance|vehicle/.test(descLower) || categoryLower === 'transport',
                isEducation: /education|school|college|university|course|books|tuition|fees|exam|study material|notebook|stationery|admission|semester|classes|coaching/.test(descLower) || categoryLower === 'education',
                isInsurance: /insurance|premium|policy|life insurance|health insurance|vehicle insurance/.test(descLower),
                
                // LESS IMPORTANT (Discretionary but useful)
                isDining: /restaurant|dineout|zomato|swiggy|cafe|coffee|starbucks|mcdonald|kfc|pizza|burger|food delivery|eating out|dinner out|lunch out/.test(descLower),
                isShopping: /shopping|clothes|fashion|accessories|jewelry|watch|shoes|mall|online shopping|amazon|flipkart|myntra|apparel|garments/.test(descLower) || categoryLower === 'shopping',
                isSubscription: /subscription|netflix|prime|spotify|gym membership|youtube premium|ott|streaming|magazine|newspaper/.test(descLower) || categoryLower === 'subscription',
                isPersonalCare: /salon|haircut|spa|grooming|cosmetics|skincare|personal care/.test(descLower),
                
                // LEAST IMPORTANT (Luxury/Entertainment)
                isLuxury: /luxury|premium|brand|designer|expensive|deluxe|5 star|five star|branded|high end|lavish/.test(descLower),
                isEntertainment: /entertainment|movie|cinema|game|gaming|party|club|bar|concert|netflix|spotify|pub|nightclub|casino|amusement park|theme park/.test(descLower) || categoryLower === 'entertainment',
                isGifts: /gift|present|birthday gift|wedding gift|donation|charity/.test(descLower),
                isHobby: /hobby|collection|sports equipment|musical instrument|photography|camera|guitar|painting/.test(descLower),
                
                // Amount-based features
                isVeryHighAmount: amount > 10000,
                isHighAmount: amount >= 5000 && amount <= 10000,
                isMediumAmount: amount >= 1000 && amount < 5000,
                isLowAmount: amount < 1000
            };
        }
        
        advancedClassification(features) {
            let score = 0;
            
            // MOST IMPORTANT scoring
            if (features.isEmergency) score += 10;
            if (features.isMedical && features.isVeryHighAmount) score += 8;
            if (features.isMedical && features.isHighAmount) score += 7;
            if (features.isMedical) score += 6;
            if (features.isRent && features.isVeryHighAmount) score += 7;
            if (features.isRent) score += 6;
            if (features.isUtility && features.isHighAmount) score += 6;
            if (features.isUtility) score += 5;
            
            // IMPORTANT scoring
            if (features.isEducation && features.isVeryHighAmount) score += 6;
            if (features.isEducation && features.isHighAmount) score += 5;
            if (features.isEducation) score += 4;
            if (features.isFood && features.isHighAmount) score += 4;
            if (features.isFood && features.isMediumAmount) score += 3;
            if (features.isFood) score += 3;
            if (features.isTransport && features.isHighAmount) score += 4;
            if (features.isTransport && features.isMediumAmount) score += 3;
            if (features.isTransport) score += 2;
            if (features.isInsurance) score += 4;
            
            // LESS IMPORTANT scoring
            if (features.isDining && features.isLowAmount) score += 2;
            if (features.isDining && features.isMediumAmount) score += 1;
            if (features.isShopping && !features.isLuxury && features.isLowAmount) score += 1;
            if (features.isShopping && !features.isLuxury && features.isMediumAmount) score += 0;
            if (features.isSubscription && features.isLowAmount) score += 1;
            if (features.isPersonalCare && features.isLowAmount) score += 1;
            
            // LEAST IMPORTANT penalties
            if (features.isLuxury) score -= 5;
            if (features.isEntertainment && features.isVeryHighAmount) score -= 4;
            if (features.isEntertainment && features.isHighAmount) score -= 3;
            if (features.isEntertainment) score -= 2;
            if (features.isShopping && features.isLuxury) score -= 5;
            if (features.isShopping && features.isVeryHighAmount) score -= 4;
            if (features.isShopping && features.isHighAmount) score -= 3;
            if (features.isDining && features.isVeryHighAmount) score -= 3;
            if (features.isDining && features.isHighAmount) score -= 2;
            if (features.isGifts && features.isHighAmount) score -= 2;
            if (features.isHobby && features.isHighAmount) score -= 3;
            
            // Classification thresholds
            if (score >= 10) return 'most_important';
            if (score >= 5) return 'important';
            if (score >= 1) return 'less_important';
            return 'least_important';
        }
    }

    class PredictiveEngine {
        constructor(expenses) {
            this.expenses = expenses || [];
        }

        predictNextMonthSpending() {
            if (this.expenses.length < 10) {
                return {
                    predicted: 0,
                    confidence: 0,
                    trend: 'neutral',
                    insight: 'Need more data for accurate predictions'
                };
            }

            const last3Months = this.getLastNMonths(3);
            const avgSpending = last3Months.reduce((sum, month) => sum + month.total, 0) / last3Months.length;
            
            const trend = this.calculateTrend(last3Months);
            const predicted = avgSpending + trend;
            
            const currentMonth = last3Months[last3Months.length - 1].total;
            const changePercent = ((predicted - currentMonth) / currentMonth * 100).toFixed(1);
            
            let trendDirection = 'neutral';
            let insight = '';
            
            if (trend > 0) {
                trendDirection = 'up';
                insight = `Spending likely to increase by ${Math.abs(changePercent)}% based on recent patterns`;
            } else if (trend < 0) {
                trendDirection = 'down';
                insight = `Great! Spending predicted to decrease by ${Math.abs(changePercent)}%`;
            } else {
                insight = 'Spending expected to remain stable';
            }

            return {
                predicted: predicted,
                confidence: this.calculateConfidence(),
                trend: trendDirection,
                insight: insight
            };
        }

        predictCategorySpike() {
            const categorySpending = this.getCategorySpendingByMonth();
            const predictions = [];

            for (const [category, months] of Object.entries(categorySpending)) {
                if (months.length < 3) continue;

                const avg = months.reduce((sum, val) => sum + val, 0) / months.length;
                const lastMonth = months[months.length - 1];
                const variance = this.calculateVariance(months);

                if (lastMonth > avg * 1.3 && variance > avg * 0.2) {
                    predictions.push({
                        category: category,
                        prediction: `${category} spending is ${((lastMonth / avg - 1) * 100).toFixed(0)}% higher than usual`,
                        risk: 'high',
                        amount: lastMonth,
                        average: avg
                    });
                }
            }

            return predictions.length > 0 ? predictions[0] : null;
        }

        predictBudgetExceedance() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const currentDay = new Date().getDate();

            const monthlyExpenses = this.expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
            });

            const spentSoFar = monthlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const dailyAverage = spentSoFar / currentDay;
            const predictedTotal = dailyAverage * daysInMonth;

            return {
                current: spentSoFar,
                predicted: predictedTotal,
                daysRemaining: daysInMonth - currentDay,
                dailyAverage: dailyAverage,
                insight: `At current rate, you'll spend ‚Çπ${predictedTotal.toFixed(0)} this month`
            };
        }

        getLastNMonths(n) {
            const monthlyData = {};
            const now = new Date();

            for (let i = n - 1; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${date.getFullYear()}-${date.getMonth()}`;
                monthlyData[key] = { total: 0, count: 0 };
            }

            this.expenses.forEach(exp => {
                const expDate = new Date(exp.date);
                const key = `${expDate.getFullYear()}-${expDate.getMonth()}`;
                if (monthlyData[key]) {
                    monthlyData[key].total += exp.amount;
                    monthlyData[key].count += 1;
                }
            });

            return Object.values(monthlyData);
        }

        calculateTrend(data) {
            if (data.length < 2) return 0;
            
            const n = data.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;

            data.forEach((point, i) => {
                sumX += i;
                sumY += point.total;
                sumXY += i * point.total;
                sumXX += i * i;
            });

            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            return slope || 0;
        }

        calculateVariance(data) {
            const mean = data.reduce((sum, val) => sum + val, 0) / data.length;
            const squaredDiffs = data.map(val => Math.pow(val - mean, 2));
            return Math.sqrt(squaredDiffs.reduce((sum, val) => sum + val, 0) / data.length);
        }

        calculateConfidence() {
            if (this.expenses.length < 20) return 60;
            if (this.expenses.length < 50) return 75;
            return 90;
        }

        getCategorySpendingByMonth() {
            const categoryData = {};
            const last6Months = this.getLastNMonths(6);
            
            this.expenses.forEach(exp => {
                if (!categoryData[exp.category]) {
                    categoryData[exp.category] = [];
                }
            });

            for (let i = 0; i < 6; i++) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const month = date.getMonth();
                const year = date.getFullYear();

                for (const category in categoryData) {
                    const monthlyTotal = this.expenses
                        .filter(exp => {
                            const expDate = new Date(exp.date);
                            return exp.category === category && 
                                   expDate.getMonth() === month && 
                                   expDate.getFullYear() === year;
                        })
                        .reduce((sum, exp) => sum + exp.amount, 0);
                    
                    categoryData[category].unshift(monthlyTotal);
                }
            }

            return categoryData;
        }
    }

    class GamificationEngine {
        constructor() {
            this.achievements = [
                { id: 'first_expense', name: 'First Step', icon: 'üéØ', desc: 'Add your first expense', xp: 10, unlocked: false },
                { id: 'expense_10', name: 'Getting Started', icon: 'üìù', desc: 'Track 10 expenses', xp: 25, unlocked: false },
                { id: 'expense_50', name: 'Dedicated Tracker', icon: 'üìä', desc: 'Track 50 expenses', xp: 50, unlocked: false },
                { id: 'expense_100', name: 'Master Tracker', icon: 'üèÜ', desc: 'Track 100 expenses', xp: 100, unlocked: false },
                { id: 'budget_set', name: 'Goal Setter', icon: 'üéØ', desc: 'Set your first budget', xp: 20, unlocked: false },
                { id: 'under_budget_7', name: 'Week Warrior', icon: 'üî•', desc: 'Stay under budget for 7 days', xp: 50, unlocked: false },
                { id: 'under_budget_30', name: 'Monthly Master', icon: 'üëë', desc: 'Stay under budget for 30 days', xp: 150, unlocked: false },
                { id: 'save_5000', name: 'Smart Saver', icon: 'üí∞', desc: 'Save ‚Çπ5000 in a month', xp: 75, unlocked: false },
                { id: 'save_10000', name: 'Savings Champion', icon: 'üíé', desc: 'Save ‚Çπ10000 in a month', xp: 150, unlocked: false },
                { id: 'no_unnecessary_7', name: 'Minimalist Week', icon: '‚ú®', desc: 'No "Least Important" expenses for 7 days', xp: 40, unlocked: false },
                { id: 'categorize_perfect', name: 'Organization Pro', icon: 'üìã', desc: 'Categorize 50 expenses perfectly', xp: 30, unlocked: false },
                { id: 'streak_7', name: 'Lucky Seven', icon: 'üçÄ', desc: '7 day tracking streak', xp: 35, unlocked: false },
                { id: 'streak_30', name: 'Consistency King', icon: 'üëë', desc: '30 day tracking streak', xp: 100, unlocked: false },
                { id: 'export_report', name: 'Data Analyst', icon: 'üìä', desc: 'Export your first report', xp: 15, unlocked: false },
                { id: 'reduce_spending', name: 'Spendthrift Slayer', icon: '‚öîÔ∏è', desc: 'Reduce spending by 20% month-over-month', xp: 80, unlocked: false }
            ];

            this.challenges = [
                { 
                    id: 'weekly_budget', 
                    name: '7-Day Budget Challenge', 
                    icon: 'üìÖ',
                    desc: 'Stay within your weekly budget for 7 consecutive days', 
                    reward: 50, 
                    progress: 0, 
                    target: 7,
                    active: false,
                    completed: false,
                    type: 'daily'
                },
                { 
                    id: 'no_luxury', 
                    name: 'No Luxury Week', 
                    icon: '‚ú®',
                    desc: 'Avoid all "Least Important" purchases for 7 days', 
                    reward: 60, 
                    progress: 0, 
                    target: 7,
                    active: false,
                    completed: false,
                    type: 'restriction'
                },
                { 
                    id: 'save_1000', 
                    name: 'Save ‚Çπ1000 Challenge', 
                    icon: 'üí∞',
                    desc: 'Save at least ‚Çπ1000 compared to last week', 
                    reward: 40, 
                    progress: 0, 
                    target: 1000,
                    active: false,
                    completed: false,
                    type: 'savings'
                },
                { 
                    id: 'track_every_day', 
                    name: 'Daily Discipline', 
                    icon: 'üìù',
                    desc: 'Log at least one expense every day for 7 days', 
                    reward: 45, 
                    progress: 0, 
                    target: 7,
                    active: false,
                    completed: false,
                    type: 'habit'
                },
                { 
                    id: 'food_budget', 
                    name: 'Foodie Control', 
                    icon: 'üçΩÔ∏è',
                    desc: 'Keep food expenses under ‚Çπ2000 this week', 
                    reward: 35, 
                    progress: 0, 
                    target: 2000,
                    active: false,
                    completed: false,
                    type: 'category'
                },
                { 
                    id: 'monthly_goal', 
                    name: 'Monthly Mastery', 
                    icon: 'üéØ',
                    desc: 'Finish the month under your total budget', 
                    reward: 100, 
                    progress: 0, 
                    target: 100,
                    active: false,
                    completed: false,
                    type: 'monthly'
                }
            ];

            this.levels = [
                { level: 1, name: 'Beginner', xpRequired: 0 },
                { level: 2, name: 'Novice', xpRequired: 100 },
                { level: 3, name: 'Learner', xpRequired: 250 },
                { level: 4, name: 'Skilled', xpRequired: 500 },
                { level: 5, name: 'Expert', xpRequired: 1000 },
                { level: 6, name: 'Master', xpRequired: 2000 },
                { level: 7, name: 'Grandmaster', xpRequired: 3500 },
                { level: 8, name: 'Legend', xpRequired: 5000 }
            ];
        }

        checkAchievements(expenses, budgets, userProfile) {
            const newAchievements = [];

            if (expenses.length >= 1 && !this.isUnlocked('first_expense', userProfile)) {
                newAchievements.push('first_expense');
            }
            if (expenses.length >= 10 && !this.isUnlocked('expense_10', userProfile)) {
                newAchievements.push('expense_10');
            }
            if (expenses.length >= 50 && !this.isUnlocked('expense_50', userProfile)) {
                newAchievements.push('expense_50');
            }
            if (expenses.length >= 100 && !this.isUnlocked('expense_100', userProfile)) {
                newAchievements.push('expense_100');
            }

            if (budgets.length >= 1 && !this.isUnlocked('budget_set', userProfile)) {
                newAchievements.push('budget_set');
            }

            const monthlySavings = this.calculateMonthlySavings(expenses, budgets);
            if (monthlySavings >= 5000 && !this.isUnlocked('save_5000', userProfile)) {
                newAchievements.push('save_5000');
            }
            if (monthlySavings >= 10000 && !this.isUnlocked('save_10000', userProfile)) {
                newAchievements.push('save_10000');
            }

            return newAchievements;
        }

        isUnlocked(achievementId, userProfile) {
            return userProfile.achievements && userProfile.achievements.includes(achievementId);
        }

        calculateMonthlySavings(expenses, budgets) {
            const now = new Date();
            const monthlyBudget = budgets.find(b => b.timeframe === 'monthly');
            if (!monthlyBudget) return 0;

            const monthlyExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getMonth() === now.getMonth() && expDate.getFullYear() === now.getFullYear();
            });

            const totalSpent = monthlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            return Math.max(0, monthlyBudget.amount - totalSpent);
        }

        calculateLevel(xp) {
            for (let i = this.levels.length - 1; i >= 0; i--) {
                if (xp >= this.levels[i].xpRequired) {
                    const currentLevel = this.levels[i];
                    const nextLevel = this.levels[i + 1];
                    const xpInCurrentLevel = xp - currentLevel.xpRequired;
                    const xpForNextLevel = nextLevel ? nextLevel.xpRequired - currentLevel.xpRequired : 1000;
                    
                    return {
                        level: currentLevel.level,
                        name: currentLevel.name,
                        currentXP: xp,
                        xpInLevel: xpInCurrentLevel,
                        xpForNext: xpForNextLevel,
                        progress: (xpInCurrentLevel / xpForNextLevel) * 100
                    };
                }
            }
            return { level: 1, name: 'Beginner', currentXP: 0, xpInLevel: 0, xpForNext: 100, progress: 0 };
        }
    }

    class RecommendationEngine {
        generateRecommendations(expenses, budgets) {
            if (!expenses || expenses.length < 5) {
                return [{
                    icon: 'üëã',
                    text: 'Welcome to WealthWise AI! Start by tracking all expenses for 2-3 weeks. Our AI will provide personalized recommendations.',
                    savings: 0
                }, {
                    icon: 'üéØ',
                    text: 'Set budget goals for different categories. Aim to stay within 90% of your budget to build a savings cushion.',
                    savings: 0
                }, {
                    icon: 'üí°',
                    text: 'Pro tip: The AI automatically classifies expense priority. Focus on reducing "Least Important" expenses first.',
                    savings: 0
                }];
            }
            
            const recommendations = [];
            const analysis = this.analyzeSpending(expenses);
            
            if (analysis.topCategory.percentage > 30) {
                recommendations.push({
                    icon: 'üéØ',
                    text: `Your '${analysis.topCategory.name}' expenses are ${analysis.topCategory.percentage.toFixed(1)}% of total spending (‚Çπ${analysis.topCategory.amount.toFixed(2)}). Reduce by 20% to save ‚Çπ${(analysis.topCategory.amount * 0.2).toFixed(2)} monthly.`,
                    savings: analysis.topCategory.amount * 0.2
                });
            }
            
            if (analysis.leastImportant > 0) {
                recommendations.push({
                    icon: 'üí°',
                    text: `You're spending ‚Çπ${analysis.leastImportant.toFixed(2)} on least important items. Cut 50% and invest in mutual funds (12% returns = ‚Çπ${(analysis.leastImportant * 0.5 * 0.12).toFixed(2)} yearly).`,
                    savings: analysis.leastImportant * 0.5
                });
            }
            
            recommendations.push({
                icon: 'üí∞',
                text: `Follow 50-30-20 rule: 50% needs, 30% wants, 20% savings (‚Çπ${(analysis.monthlyTotal * 0.2).toFixed(2)}). Invest in SIP/PPF.`,
                savings: analysis.monthlyTotal * 0.2
            });
            
            recommendations.push({
                icon: 'üìù',
                text: 'Smart tips: Use cashback apps (5-10%), cook at home 5 days/week (save ‚Çπ4000), cancel unused subscriptions, buy groceries in bulk (15% off).',
                savings: 4000
            });
            
            return recommendations.slice(0, 5);
        }
        
        analyzeSpending(expenses) {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
            });
            
            const totalAmount = monthlyExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
            
            const byCategory = {};
            monthlyExpenses.forEach(exp => {
                byCategory[exp.category] = (byCategory[exp.category] || 0) + parseFloat(exp.amount);
            });
            
            const topCategoryName = Object.keys(byCategory).reduce((a, b) => 
                byCategory[a] > byCategory[b] ? a : b, Object.keys(byCategory)[0] || 'Other'
            );
            
            const leastImportant = monthlyExpenses
                .filter(exp => exp.priority === 'least_important')
                .reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
            
            return {
                monthlyTotal: totalAmount || 0,
                topCategory: {
                    name: topCategoryName,
                    amount: byCategory[topCategoryName] || 0,
                    percentage: totalAmount > 0 ? (byCategory[topCategoryName] || 0) / totalAmount * 100 : 0
                },
                leastImportant: leastImportant
            };
        }
    }

    class ExcelExportEngine {
        constructor(expenses, budgets, userName) {
            this.expenses = expenses || [];
            this.budgets = budgets || [];
            this.userName = userName;
        }

        generateFullReport() {
            const wb = XLSX.utils.book_new();
            
            this.addSummarySheet(wb);
            this.addExpensesSheet(wb);
            this.addMonthlySheet(wb);
            this.addWeeklySheet(wb);
            this.addCategorySheet(wb);
            this.addPrioritySheet(wb);
            this.addBudgetSheet(wb);
            
            XLSX.writeFile(wb, `WealthWiseAI_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            return true;
        }

        generateMonthlyReport() {
            const wb = XLSX.utils.book_new();
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthlyExpenses = this.expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
            });
            
            const data = [
                ['MONTHLY EXPENSE BREAKDOWN - WealthWise AI', `${now.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })}`],
                [],
                ['Date', 'Description', 'Category', 'Amount (‚Çπ)', 'Priority'],
                ...monthlyExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => [
                    new Date(exp.date).toLocaleDateString('en-IN'),
                    exp.description,
                    exp.category,
                    exp.amount,
                    exp.priority.replace(/_/g, ' ')
                ]),
                [],
                ['TOTAL', '', '', monthlyExpenses.reduce((sum, exp) => sum + exp.amount, 0)]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 15 }, { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Monthly');
            
            XLSX.writeFile(wb, `WealthWiseAI_Monthly_${now.toLocaleDateString('en-IN', { month: 'short' })}.xlsx`);
            return true;
        }

        generateWeeklyReport() {
            const wb = XLSX.utils.book_new();
            const now = new Date();
            const weekAgo = new Date(now);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const weeklyExpenses = this.expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate >= weekAgo;
            });
            
            const data = [
                ['WEEKLY EXPENSE SUMMARY - WealthWise AI', `Last 7 Days`],
                [],
                ['Date', 'Description', 'Category', 'Amount (‚Çπ)', 'Priority'],
                ...weeklyExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => [
                    new Date(exp.date).toLocaleDateString('en-IN'),
                    exp.description,
                    exp.category,
                    exp.amount,
                    exp.priority.replace(/_/g, ' ')
                ]),
                [],
                ['TOTAL', '', '', weeklyExpenses.reduce((sum, exp) => sum + exp.amount, 0)]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 15 }, { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Weekly');
            
            XLSX.writeFile(wb, `WealthWiseAI_Weekly_${now.toISOString().split('T')[0]}.xlsx`);
            return true;
        }

        generateBudgetReport() {
            const wb = XLSX.utils.book_new();
            this.addBudgetSheet(wb);
            XLSX.writeFile(wb, `WealthWiseAI_Budget_Report.xlsx`);
            return true;
        }

        addSummarySheet(wb) {
            const totalSpent = this.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const avgExpense = this.expenses.length > 0 ? totalSpent / this.expenses.length : 0;
            
            const data = [
                ['FINANCIAL SUMMARY - WealthWise AI'],
                ['User', this.userName],
                ['Generated On', new Date().toLocaleDateString('en-IN')],
                [],
                ['Total Expenses', this.expenses.length],
                ['Total Amount Spent', `‚Çπ${totalSpent.toFixed(2)}`],
                ['Average Expense', `‚Çπ${avgExpense.toFixed(2)}`],
                ['Active Budgets', this.budgets.length],
                [],
                ['Top 5 Categories'],
                ...this.getTopCategories(5)
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 25 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Summary');
        }

        addExpensesSheet(wb) {
            const data = [
                ['Date', 'Description', 'Category', 'Amount (‚Çπ)', 'Priority'],
                ...this.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => [
                    new Date(exp.date).toLocaleDateString('en-IN'),
                    exp.description,
                    exp.category,
                    exp.amount,
                    exp.priority.replace(/_/g, ' ')
                ])
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 15 }, { wch: 30 }, { wch: 20 }, { wch: 15 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws, 'All Expenses');
        }

        addMonthlySheet(wb) {
            const now = new Date();
            const monthlyExpenses = this.expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getMonth() === now.getMonth() && expDate.getFullYear() === now.getFullYear();
            });
            
            if (monthlyExpenses.length === 0) return;
            
            const data = [
                ['MONTHLY BREAKDOWN', now.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })],
                [],
                ['Date', 'Description', 'Category', 'Amount (‚Çπ)', 'Priority'],
                ...monthlyExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => [
                    new Date(exp.date).toLocaleDateString('en-IN'),
                    exp.description,
                    exp.category,
                    exp.amount,
                    exp.priority.replace(/_/g, ' ')
                ]),
                [],
                ['TOTAL', '', '', monthlyExpenses.reduce((sum, exp) => sum + exp.amount, 0)]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 15 }, { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws, 'This Month');
        }

        addWeeklySheet(wb) {
            const now = new Date();
            const weekAgo = new Date(now);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const weeklyExpenses = this.expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate >= weekAgo;
            });
            
            if (weeklyExpenses.length === 0) return;
            
            const data = [
                ['WEEKLY SUMMARY', 'Last 7 Days'],
                [],
                ['Date', 'Description', 'Category', 'Amount (‚Çπ)', 'Priority'],
                ...weeklyExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => [
                    new Date(exp.date).toLocaleDateString('en-IN'),
                    exp.description,
                    exp.category,
                    exp.amount,
                    exp.priority.replace(/_/g, ' ')
                ]),
                [],
                ['TOTAL', '', '', weeklyExpenses.reduce((sum, exp) => sum + exp.amount, 0)]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 15 }, { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws, 'This Week');
        }

        addCategorySheet(wb) {
            const categoryData = this.getCategorySummary(this.expenses);
            const totalSpent = this.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const data = [
                ['CATEGORY-WISE ANALYSIS'],
                [],
                ['Category', 'Total (‚Çπ)', 'Count', 'Average (‚Çπ)', 'Percentage (%)'],
                ...Object.entries(categoryData).map(([cat, info]) => [
                    cat,
                    info.total.toFixed(2),
                    info.count,
                    (info.total / info.count).toFixed(2),
                    ((info.total / totalSpent) * 100).toFixed(2)
                ])
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Categories');
        }

        addPrioritySheet(wb) {
            const priorityData = this.getPrioritySummary();
            const totalSpent = this.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const data = [
                ['PRIORITY-WISE ANALYSIS (AI CLASSIFIED)'],
                [],
                ['Priority', 'Count', 'Total (‚Çπ)', 'Average (‚Çπ)', 'Percentage (%)'],
                ...Object.entries(priorityData).map(([priority, info]) => [
                    priority.replace(/_/g, ' ').toUpperCase(),
                    info.count,
                    info.total.toFixed(2),
                    (info.total / info.count || 0).toFixed(2),
                    ((info.total / totalSpent || 0) * 100).toFixed(2)
                ])
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Priority');
        }

        addBudgetSheet(wb) {
            const now = new Date();
            const data = [
                ['BUDGET vs ACTUAL COMPARISON'],
                [],
                ['Category', 'Timeframe', 'Budget (‚Çπ)', 'Spent (‚Çπ)', 'Remaining (‚Çπ)', 'Usage %', 'Status']
            ];
            
            this.budgets.forEach(budget => {
                let totalSpent = 0;
                let status = 'Within Budget';
                
                if (budget.timeframe === 'weekly') {
                    const weekAgo = new Date(now);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    const weeklyExpenses = this.expenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        const matchesCategory = budget.category === 'General' || exp.category === budget.category;
                        return expDate >= weekAgo && matchesCategory;
                    });
                    totalSpent = weeklyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                } else if (budget.timeframe === 'monthly') {
                    const monthlyExpenses = this.expenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        const matchesCategory = budget.category === 'General' || exp.category === budget.category;
                        return expDate.getMonth() === now.getMonth() && 
                               expDate.getFullYear() === now.getFullYear() &&
                               matchesCategory;
                    });
                    totalSpent = monthlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                } else if (budget.timeframe === 'yearly') {
                    const yearlyExpenses = this.expenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        const matchesCategory = budget.category === 'General' || exp.category === budget.category;
                        return expDate.getFullYear() === now.getFullYear() && matchesCategory;
                    });
                    totalSpent = yearlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                }
                
                const budgetAmount = parseFloat(budget.amount);
                const remaining = budgetAmount - totalSpent;
                const percentage = (totalSpent / budgetAmount) * 100;
                
                if (totalSpent > budgetAmount) status = 'EXCEEDED';
                else if (percentage >= 90) status = 'WARNING';
                
                data.push([
                    budget.category,
                    budget.timeframe.charAt(0).toUpperCase() + budget.timeframe.slice(1),
                    budgetAmount.toFixed(2),
                    totalSpent.toFixed(2),
                    remaining.toFixed(2),
                    percentage.toFixed(1) + '%',
                    status
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Budget');
        }

        getTopCategories(limit) {
            const categoryData = this.getCategorySummary(this.expenses);
            return Object.entries(categoryData)
                .sort(([, a], [, b]) => b.total - a.total)
                .slice(0, limit)
                .map(([cat, info]) => [cat, `‚Çπ${info.total.toFixed(2)}`]);
        }

        getCategorySummary(expenses) {
            const summary = {};
            expenses.forEach(exp => {
                if (!summary[exp.category]) {
                    summary[exp.category] = { total: 0, count: 0 };
                }
                summary[exp.category].total += exp.amount;
                summary[exp.category].count += 1;
            });
            return summary;
        }

        getPrioritySummary() {
            const summary = {
                'most_important': { total: 0, count: 0 },
                'important': { total: 0, count: 0 },
                'less_important': { total: 0, count: 0 },
                'least_important': { total: 0, count: 0 }
            };
            
            this.expenses.forEach(exp => {
                if (summary[exp.priority]) {
                    summary[exp.priority].total += exp.amount;
                    summary[exp.priority].count += 1;
                }
            });
            
            return summary;
        }

        getDailyBreakdown(expenses) {
            const dailyData = {};
            expenses.forEach(exp => {
                const date = new Date(exp.date).toLocaleDateString('en-IN');
                if (!dailyData[date]) {
                    dailyData[date] = { total: 0, count: 0, date: date };
                }
                dailyData[date].total += exp.amount;
                dailyData[date].count += 1;
            });
            
            return Object.values(dailyData).sort((a, b) => new Date(b.date) - new Date(a.date));
        }
    }

    const expenseClassifier = new ExpenseClassifier();
    const recommendationEngine = new RecommendationEngine();
    const gamificationEngine = new GamificationEngine();

    let currentUser = null;
    let userProfile = {
        xp: 0,
        level: 1,
        achievements: [],
        activeChallenges: [],
        streak: 0,
        lastActiveDate: null
    };
    let currentTimeframe = 'weekly';
    let expenseChart, categoryChart, priorityChart, predictionChart, patternChart;
    let allExpenses = [];
    let allBudgets = [];

    onAuthStateChanged(auth, (user) => {
        console.log('Auth state changed:', user ? `User: ${user.uid}` : 'No user');
        
        if (user) {
            currentUser = {
                uid: user.uid,
                name: user.displayName || 'User',
                email: user.email
            };
            console.log('‚úÖ Current user set:', currentUser);
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            initializeDashboard();
            setupEventListeners();
            loadFirebaseData();
            loadUserProfile();
        } else {
            console.log('No authenticated user, redirecting to login');
            window.location.href = 'index.html';
        }
    });

    function initializeDashboard() {
        document.getElementById('greeting').textContent = `Welcome, ${currentUser.name}!`;
        document.getElementById('expDate').valueAsDate = new Date();
        
        // Reset alert tracking every hour
        setInterval(() => {
            window.shownAlertKeys = new Set();
        }, 3600000);
    }

    function loadUserProfile() {
        console.log('=== LOADING USER PROFILE ===');
        
        // Load from localStorage (source of truth)
        try {
            const storedProfile = localStorage.getItem('userProfile');
            if (storedProfile) {
                const parsedProfile = JSON.parse(storedProfile);
                userProfile = parsedProfile;
                console.log('‚úÖ User profile loaded from localStorage, XP:', userProfile.xp);
            } else {
                console.log('No stored profile, using default');
                userProfile = {
                    xp: 0,
                    level: 1,
                    achievements: [],
                    activeChallenges: [],
                    streak: 0,
                    lastActiveDate: null,
                    challenges: null
                };
            }
        } catch (err) {
            console.error('Error loading profile from localStorage:', err);
            userProfile = {
                xp: 0,
                level: 1,
                achievements: [],
                activeChallenges: [],
                streak: 0,
                lastActiveDate: null,
                challenges: null
            };
        }
        
        // Initialize challenges if needed
        if (!userProfile.challenges || userProfile.challenges.length === 0) {
            userProfile.challenges = JSON.parse(JSON.stringify(gamificationEngine.challenges));
            saveUserProfile();
            console.log('Challenges initialized');
        } else {
            gamificationEngine.challenges = userProfile.challenges;
            console.log('Challenges loaded from profile');
        }
        
        // Ensure all properties exist
        if (!userProfile.xp) userProfile.xp = 0;
        if (!userProfile.achievements) userProfile.achievements = [];
        if (!userProfile.activeChallenges) userProfile.activeChallenges = [];
        if (!userProfile.streak) userProfile.streak = 0;
        
        console.log('‚úÖ Profile loading complete. Final XP:', userProfile.xp);
        updateGamificationUI();
        
        // Optional: Sync from Firebase in background (for cloud backup only)
        if (currentUser && currentUser.uid) {
            const profileRef = ref(database, 'profiles/' + currentUser.uid);
            get(profileRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const fbProfile = snapshot.val();
                    console.log('Firebase profile check - FB XP:', fbProfile.xp, 'Local XP:', userProfile.xp);
                    
                    // Only update if Firebase has MORE XP (cloud recovery)
                    if (fbProfile.xp && fbProfile.xp > userProfile.xp) {
                        console.log('Updating from Firebase (higher XP):', fbProfile.xp);
                        userProfile.xp = fbProfile.xp;
                        updateGamificationUI();
                    }
                }
            }).catch(err => console.warn('Firebase sync check failed:', err.message));
        }
    }

    function saveUserProfile() {
        console.log('=== SAVING USER PROFILE ===');
        console.log('Current XP before save:', userProfile.xp);
        
        try {
            // STEP 1: Always save to localStorage FIRST (source of truth)
            if (userProfile) {
                const profileCopy = JSON.parse(JSON.stringify(userProfile));
                localStorage.setItem('userProfile', JSON.stringify(profileCopy));
                console.log('‚úÖ STEP 1 COMPLETE: Saved to localStorage with XP:', profileCopy.xp);
            }
            
            // STEP 2: Also sync to Firebase (async, non-blocking)
            if (currentUser && currentUser.uid) {
                const profileRef = ref(database, 'profiles/' + currentUser.uid);
                set(profileRef, userProfile)
                    .then(() => {
                        console.log('‚úÖ STEP 2 COMPLETE: Firebase sync successful, XP:', userProfile.xp);
                    })
                    .catch(error => {
                        console.warn('‚ö†Ô∏è Firebase sync failed (but localStorage is safe):', error.message);
                    });
            }
        } catch (error) {
            console.error('‚ùå CRITICAL: Error saving profile:', error);
        }
        
        console.log('Final XP after save:', userProfile.xp);
    }

    function addXP(amount, reason) {
        console.log('=== ADDING XP ===');
        console.log('Amount:', amount, '| Reason:', reason);
        console.log('Before: userProfile.xp =', userProfile.xp);
        
        try {
            if (!userProfile) {
                console.error('‚ùå userProfile is not initialized!');
                return;
            }
            
            // Add XP
            const oldXP = userProfile.xp || 0;
            userProfile.xp = (userProfile.xp || 0) + amount;
            const newXP = userProfile.xp;
            
            console.log('After: userProfile.xp =', newXP, '(+' + amount + ')');
            
            // Save immediately to localStorage and Firebase
            saveUserProfile();
            
            // Show notification
            showNotification(`+${amount} XP earned! ${reason}`, 'success');
            createConfetti();
            
            // Update UI
            updateGamificationUI();
            
            console.log('‚úÖ XP addition complete. Final XP:', userProfile.xp);
        } catch (error) {
            console.error('‚ùå Error in addXP:', error);
        }
    }

    function unlockAchievement(achievementId) {
        const achievement = gamificationEngine.achievements.find(a => a.id === achievementId);
        if (!achievement) return;

        if (!userProfile.achievements.includes(achievementId)) {
            userProfile.achievements.push(achievementId);
            userProfile.xp += achievement.xp;
            saveUserProfile();
            
            showNotification(`üèÜ Achievement Unlocked: ${achievement.name}! +${achievement.xp} XP`, 'success');
            
            const badge = document.getElementById('newAchievementsBadge');
            if (badge) badge.style.display = 'block';
            
            createConfetti(30);
            updateGamificationUI();
        }
    }

    function createConfetti(count = 15) {
        for (let i = 0; i < count; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'][Math.floor(Math.random() * 5)];
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }, i * 50);
        }
    }

    function updateGamificationUI() {
        try {
            console.log('üîÑ START updateGamificationUI');
            
            if (!userProfile) {
                console.warn('‚ùå userProfile not available for UI update');
                return;
            }
            
            console.log('üìä Current userProfile.xp:', userProfile.xp);
            
            const levelInfo = gamificationEngine.calculateLevel(userProfile.xp);
            console.log('üìä Level info:', levelInfo);
            
            // Get elements from DOM
            const userLevelEl = document.getElementById('userLevel');
            const userXpEl = document.getElementById('userXP');
            const xpProgressEl = document.getElementById('xpProgress');
            const xpTextEl = document.getElementById('xpText');
            
            console.log('üîç Elements found - Level:', !!userLevelEl, 'XP:', !!userXpEl, 'Progress:', !!xpProgressEl, 'Text:', !!xpTextEl);
            
            // Update each element and log
            if (userLevelEl) {
                const newText = `Level ${levelInfo.level} - ${levelInfo.name}`;
                userLevelEl.textContent = newText;
                console.log('‚úÖ Level updated to:', newText);
            } else {
                console.warn('‚ö†Ô∏è userLevel element not found');
            }
            
            if (userXpEl) {
                const newText = `${userProfile.xp} XP`;
                userXpEl.textContent = newText;
                console.log('‚úÖ XP text updated to:', newText);
            } else {
                console.warn('‚ö†Ô∏è userXP element not found');
            }
            
            if (xpProgressEl) {
                const newWidth = levelInfo.progress + '%';
                xpProgressEl.style.width = newWidth;
                console.log('‚úÖ Progress bar updated to:', newWidth);
            } else {
                console.warn('‚ö†Ô∏è xpProgress element not found');
            }
            
            if (xpTextEl) {
                const newText = `${levelInfo.xpInLevel} / ${levelInfo.xpForNext} XP to next level`;
                xpTextEl.textContent = newText;
                console.log('‚úÖ XP info updated to:', newText);
            } else {
                console.warn('‚ö†Ô∏è xpText element not found');
            }
            
            console.log('‚úÖ COMPLETE updateGamificationUI - Final XP:', userProfile.xp, 'Level:', levelInfo.level);
            
            // Re-render other sections
            renderAchievements();
            renderChallenges();
            renderLeaderboard();
        } catch (error) {
            console.error('‚ùå CRITICAL Error in updateGamificationUI:', error);
            console.error('Error stack:', error.stack);
        }
    }

    function renderAchievements() {
        const container = document.getElementById('achievementsGrid');
        container.innerHTML = '';
        
        gamificationEngine.achievements.forEach(achievement => {
            const isUnlocked = userProfile.achievements.includes(achievement.id);
            const card = document.createElement('div');
            card.className = `achievement-badge ${isUnlocked ? 'unlocked' : 'locked'}`;
            card.innerHTML = `
                <div class="achievement-xp">+${achievement.xp}</div>
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-name">${achievement.name}</div>
                <div class="achievement-desc">${achievement.desc}</div>
            `;
            container.appendChild(card);
        });
    }

    function renderChallenges() {
        const container = document.getElementById('challengesGrid');
        if (!container) return;
        
        container.innerHTML = '';
        
        let challenges = userProfile.challenges || gamificationEngine.challenges;
        
        // Ensure challenges is an array
        if (!Array.isArray(challenges)) {
            challenges = gamificationEngine.challenges;
        }
        
        if (challenges.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px; grid-column: 1/-1;">No challenges available. Start tracking to unlock challenges!</p>';
            return;
        }
        
        challenges.forEach((challenge, index) => {
            const progress = challenge.progress || 0;
            const target = challenge.target || 1;
            const progressPercent = Math.min((progress / target) * 100, 100);
            const card = document.createElement('div');
            card.className = `challenge-card ${challenge.active ? 'active' : ''} ${challenge.completed ? 'completed' : ''}`;
            card.innerHTML = `
                <div class="challenge-header">
                    <div class="challenge-title">
                        <span style="font-size: 1.5em;">${challenge.icon || 'üéØ'}</span>
                        ${challenge.name || 'Challenge'}
                    </div>
                    <div class="challenge-reward">+${challenge.reward || 0} XP</div>
                </div>
                <p class="challenge-desc">${challenge.desc || 'Complete this challenge'}</p>
                <div class="challenge-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="progress-text">${progress}/${target}</div>
                </div>
                <div class="challenge-actions">
                    ${!challenge.active && !challenge.completed ? 
                        `<button class="btn-challenge btn-start" onclick="window.startChallenge('${challenge.id}')">Start Challenge</button>` : ''}
                    ${challenge.completed ? 
                        `<button class="btn-challenge btn-complete" disabled>‚úì Completed</button>` : ''}
                    ${challenge.active && !challenge.completed ? 
                        `<span style="color: var(--success-color); font-weight: 600;">üî• In Progress</span>` : ''}
                </div>
            `;
            container.appendChild(card);
        });
    }

    window.startChallenge = function(challengeId) {
        if (!userProfile.challenges) {
            userProfile.challenges = JSON.parse(JSON.stringify(gamificationEngine.challenges));
        }
        
        if (!Array.isArray(userProfile.challenges)) {
            userProfile.challenges = gamificationEngine.challenges;
        }
        
        const challenge = userProfile.challenges.find(c => c.id === challengeId);
        if (challenge && !challenge.completed) {
            challenge.active = true;
            if (!userProfile.activeChallenges) {
                userProfile.activeChallenges = [];
            }
            if (!userProfile.activeChallenges.includes(challengeId)) {
                userProfile.activeChallenges.push(challengeId);
            }
            saveUserProfile();
            renderChallenges();
            updateGamificationUI();
            showNotification(`üèÜ Challenge Started: ${challenge.name}`, 'success');
        }
    };

    function renderLeaderboard() {
        const container = document.getElementById('leaderboardList');
        
        const leaderboard = [
            { name: currentUser.name, score: `${userProfile.xp} XP`, points: userProfile.xp, isCurrentUser: true },
            { name: 'Arjun K', score: '2450 XP', points: 2450, isCurrentUser: false },
            { name: 'Priya S', score: '2100 XP', points: 2100, isCurrentUser: false },
            { name: 'Rahul M', score: '1850 XP', points: 1850, isCurrentUser: false },
            { name: 'Ananya P', score: '1600 XP', points: 1600, isCurrentUser: false }
        ].sort((a, b) => b.points - a.points);

        container.innerHTML = '';
        leaderboard.forEach((user, index) => {
            const item = document.createElement('div');
            item.className = 'leaderboard-item';
            item.style.background = user.isCurrentUser ? 'linear-gradient(to right, rgba(168, 85, 247, 0.15), rgba(34, 211, 238, 0.1))' : 'transparent';
            item.style.borderLeft = user.isCurrentUser ? '3px solid var(--primary-color)' : 'none';
            item.innerHTML = `
                <div class="leaderboard-rank ${index === 0 ? 'top-1' : index === 1 ? 'top-2' : index === 2 ? 'top-3' : ''}">${index + 1}</div>
                <div class="leaderboard-avatar">${user.name.charAt(0)}</div>
                <div class="leaderboard-info">
                    <div class="leaderboard-name">${user.name} ${user.isCurrentUser ? '(You)' : ''}</div>
                    <div class="leaderboard-score">Level ${gamificationEngine.calculateLevel(user.points).level}</div>
                </div>
                <div class="leaderboard-points">${user.score}</div>
            `;
            container.appendChild(item);
        });

        document.getElementById('currentStreak').textContent = userProfile.streak || 0;
    }

    function loadFirebaseData() {
        const expensesRef = ref(database, 'expenses/' + currentUser.uid);
        onValue(expensesRef, (snapshot) => {
            allExpenses = [];
            snapshot.forEach((childSnapshot) => {
                allExpenses.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });
            updateDashboard();
            
            const newAchievements = gamificationEngine.checkAchievements(allExpenses, allBudgets, userProfile);
            newAchievements.forEach(achievementId => {
                if (!userProfile.achievements.includes(achievementId)) {
                    unlockAchievement(achievementId);
                }
            });
        });

        const budgetsRef = ref(database, 'budgets/' + currentUser.uid);
        onValue(budgetsRef, (snapshot) => {
            allBudgets = [];
            snapshot.forEach((childSnapshot) => {
                allBudgets.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });
            updateDashboard();
        });
    }

    function setupEventListeners() {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const section = e.currentTarget.dataset.section;
                if (section) {
                    switchSection(section);
                }
            });
        });

        document.getElementById('logout').addEventListener('click', logout);

        document.getElementById('addExpenseBtn').addEventListener('click', () => {
            document.getElementById('expenseModal').style.display = 'block';
        });

        document.getElementById('setBudgetBtn').addEventListener('click', () => {
            document.getElementById('budgetModal').style.display = 'block';
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            document.getElementById('exportModal').style.display = 'block';
        });

        document.querySelectorAll('.export-option').forEach(option => {
            option.addEventListener('click', (e) => {
                const type = e.currentTarget.dataset.type;
                handleExport(type);
                document.getElementById('exportModal').style.display = 'none';
            });
        });
        
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', (e) => {
                e.target.closest('.modal').style.display = 'none';
            });
        });
        
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
        document.getElementById('budgetForm').addEventListener('submit', handleBudgetSubmit);
        
        document.querySelectorAll('.chart-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentTimeframe = e.target.dataset.timeframe;
                updateCharts();
            });
        });
    }

    function switchSection(sectionName) {
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(`${sectionName}-section`).classList.add('active');

        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        const navItem = document.querySelector(`[data-section="${sectionName}"]`);
        if (navItem) navItem.classList.add('active');

        if (sectionName === 'predictions') {
            renderPredictions();
        }

        if (sectionName === 'recommendations') {
            loadRecommendations();
            const badge = document.getElementById('newRecommendationsBadge');
            if (badge) badge.style.display = 'none';
        }

        if (sectionName === 'gamification') {
            const badge = document.getElementById('newAchievementsBadge');
            if (badge) badge.style.display = 'none';
        }
    }

    function handleExport(type) {
        const exportBtn = document.getElementById('exportBtn');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<div class="loading-spinner"></div> Generating...';
        exportBtn.disabled = true;

        setTimeout(() => {
            try {
                const exporter = new ExcelExportEngine(allExpenses, allBudgets, currentUser.name);
                
                if (type === 'full') {
                    exporter.generateFullReport();
                } else if (type === 'monthly') {
                    exporter.generateMonthlyReport();
                } else if (type === 'weekly') {
                    exporter.generateWeeklyReport();
                } else if (type === 'budget') {
                    exporter.generateBudgetReport();
                }
                
                showNotification('‚úÖ Excel file downloaded successfully!', 'success');
                
                if (!userProfile.achievements.includes('export_report')) {
                    unlockAchievement('export_report');
                }
            } catch (error) {
                console.error('Export error:', error);
                showNotification('‚ùå Error generating Excel file!', 'error');
            } finally {
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }
        }, 500);
    }

    // ‚úÖ FIXED Expense Submit Handler
    async function handleExpenseSubmit(e) {
        e.preventDefault();
        
        console.log('=== EXPENSE SUBMIT STARTED ===');
        
        const submitBtn = document.getElementById('submitExpenseBtn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Adding...';
        submitBtn.disabled = true;
        
        const amount = document.getElementById('expAmount').value;
        const category = document.getElementById('expCategory').value.trim();
        const description = document.getElementById('expDescription').value.trim();
        const date = document.getElementById('expDate').value;
        
        console.log('Form values:', {amount, category, description, date});
        console.log('Current user:', currentUser);
        
        if (!category || !description || !amount || !date) {
            console.warn('‚ùå Validation failed - missing fields');
            showNotification('‚ùå Please fill all fields!', 'error');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
        }
        
        try {
            console.log('Step 1: Classifying expense...');
            const priority = expenseClassifier.classifyExpense(amount, category, description);
            console.log('Priority:', priority);
            
            const expense = {
                amount: parseFloat(amount),
                category: category,
                description: description,
                date: date,
                priority: priority,
                createdAt: new Date().toISOString()
            };
            
            console.log('Step 2: Saving to localStorage...');
            
            // Get existing expenses
            let expenses = [];
            try {
                const stored = localStorage.getItem('expenses');
                if (stored) {
                    expenses = JSON.parse(stored);
                }
            } catch (parseErr) {
                console.warn('Parse error, starting fresh:', parseErr);
                expenses = [];
            }
            
            if (!Array.isArray(expenses)) {
                expenses = [];
            }
            
            // Create new expense with ID
            const newExpense = {
                id: 'exp_' + Date.now(),
                userId: currentUser ? currentUser.uid : 'unknown',
                ...expense
            };
            
            expenses.push(newExpense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            console.log('‚úÖ Saved to localStorage. Total expenses:', expenses.length);
            
            // Update allExpenses
            allExpenses = [...expenses];
            console.log('Updated allExpenses:', allExpenses.length);
            
            console.log('Step 3: Attempting Firebase sync...');
            
            // Try Firebase sync (don't block on failure)
            if (currentUser && currentUser.uid && database) {
                try {
                    const expensesRef = ref(database, 'expenses/' + currentUser.uid);
                    const result = await push(expensesRef, expense);
                    console.log('‚úÖ Firebase sync successful:', result.key);
                } catch (fbErr) {
                    console.warn('‚ö†Ô∏è Firebase sync failed (local save OK):', fbErr.code, fbErr.message);
                }
            } else {
                console.warn('Firebase not available (local save only)');
            }
            
            console.log('Step 4: Closing modal and resetting form...');
            document.getElementById('expenseModal').style.display = 'none';
            document.getElementById('expenseForm').reset();
            document.getElementById('expDate').valueAsDate = new Date();
            
            console.log('Step 5: Showing success message and adding XP...');
            showNotification(`‚úÖ Expense added successfully! AI classified as: ${priority.replace(/_/g, ' ').toUpperCase()}`, 'success');
            
            console.log('Step 6: Adding XP (+5 for tracking expense)...');
            try {
                if (!userProfile) {
                    console.error('‚ùå userProfile is null/undefined!');
                    userProfile = {xp: 0, level: 1, achievements: [], activeChallenges: [], streak: 0};
                }
                
                const xpBefore = userProfile.xp || 0;
                userProfile.xp = (userProfile.xp || 0) + 5;
                const xpAfter = userProfile.xp;
                
                console.log(`XP: ${xpBefore} ‚Üí ${xpAfter} (+5)`);
                
                // Save immediately
                saveUserProfile();
                console.log('‚úÖ Profile saved with new XP:', userProfile.xp);
                
                // Update UI
                updateGamificationUI();
                createConfetti();
                console.log('‚úÖ UI updated, confetti created');
                
            } catch (xpErr) {
                console.error('‚ùå Error adding XP:', xpErr);
            }
            
            console.log('Step 7: Triggering alerts and updates...');
            setTimeout(() => {
                try {
                    checkBudgetAlerts(newExpense);
                    updateChallengeProgress();
                    updateDashboard();
                    console.log('‚úÖ All updates completed');
                } catch (updateErr) {
                    console.error('Update error (non-critical):', updateErr);
                }
            }, 200);
            
            console.log('=== EXPENSE SUBMIT COMPLETED SUCCESSFULLY ===');
            
        } catch (error) {
            console.error('=== EXPENSE SUBMIT FAILED ===');
            console.error('Error name:', error.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            console.error('Current state:', {
                userUid: currentUser ? currentUser.uid : 'undefined',
                dbReady: database ? 'yes' : 'no',
                expensesCount: allExpenses.length
            });
            
            showNotification('‚ùå Failed to add expense. Please check console for details.', 'error');
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    // ‚úÖ FIXED Budget Submit Handler
    async function handleBudgetSubmit(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBudgetBtn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Setting...';
        submitBtn.disabled = true;
        
        const amount = document.getElementById('budgetAmount').value;
        const timeframe = document.getElementById('budgetTimeframe').value;
        const category = document.getElementById('budgetCategory').value;
        
        const budget = {
            id: Date.now().toString(),
            amount: parseFloat(amount),
            timeframe: timeframe,
            category: category,
            userId: currentUser.uid,
            createdAt: new Date().toISOString()
        };
        
        try {
            // Store to localStorage first
            const budgets = JSON.parse(localStorage.getItem('budgets') || '[]');
            budgets.push(budget);
            localStorage.setItem('budgets', JSON.stringify(budgets));
            allBudgets.push(budget);
            
            // Also try Firebase
            if (database && currentUser && currentUser.uid) {
                const budgetsRef = ref(database, 'budgets/' + currentUser.uid);
                push(budgetsRef, budget).catch(fbError => {
                    console.warn('Firebase sync delayed:', fbError);
                });
            }
            
            document.getElementById('budgetModal').style.display = 'none';
            document.getElementById('budgetForm').reset();
            
            showNotification(`‚úÖ Budget set successfully! ${timeframe.charAt(0).toUpperCase() + timeframe.slice(1)} budget of ‚Çπ${amount} for ${category}`, 'success');
            
            // Add XP for setting budget (+10)
            try {
                if (!userProfile) {
                    console.error('‚ùå userProfile is null/undefined!');
                    userProfile = {xp: 0, level: 1, achievements: [], activeChallenges: [], streak: 0};
                }
                
                const xpBefore = userProfile.xp || 0;
                userProfile.xp = (userProfile.xp || 0) + 10;
                const xpAfter = userProfile.xp;
                
                console.log(`Budget XP: ${xpBefore} ‚Üí ${xpAfter} (+10)`);
                
                // Save immediately
                saveUserProfile();
                console.log('‚úÖ Profile saved with new XP:', userProfile.xp);
                
                // Update UI
                updateGamificationUI();
                console.log('‚úÖ Budget UI updated');
                
            } catch (xpErr) {
                console.error('‚ùå Error adding budget XP:', xpErr);
            }
            
            console.log('‚úÖ Budget set:', budget);
            
            // Trigger alerts check
            setTimeout(() => {
                checkBudgetAlerts(null);
                updateDashboard();
            }, 300);
            
            if (!userProfile.achievements.includes('budget_set')) {
                unlockAchievement('budget_set');
            }
        } catch (error) {
            console.error('‚ùå Error setting budget:', error);
            showNotification('‚ùå Failed to set budget. Please try again.', 'error');
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    function updateChallengeProgress() {
        if (!userProfile.challenges) {
            userProfile.challenges = gamificationEngine.challenges;
        }
        
        const now = new Date();
        const weekAgo = new Date(now);
        weekAgo.setDate(weekAgo.getDate() - 7);
        
        userProfile.activeChallenges.forEach(challengeId => {
            const challenge = userProfile.challenges.find(c => c.id === challengeId);
            if (!challenge || challenge.completed) return;

            if (challenge.type === 'daily') {
                let daysUnderBudget = 0;
                const monthlyBudget = allBudgets.find(b => b.timeframe === 'monthly');
                if (monthlyBudget) {
                    const dailyBudget = monthlyBudget.amount / 30;
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(now);
                        date.setDate(date.getDate() - i);
                        const dayExpenses = allExpenses.filter(exp => {
                            const expDate = new Date(exp.date);
                            return expDate.toDateString() === date.toDateString();
                        });
                        const dayTotal = dayExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                        if (dayTotal <= dailyBudget) daysUnderBudget++;
                    }
                    challenge.progress = daysUnderBudget;
                }
            } else if (challenge.type === 'restriction') {
                const luxuryExpenses = allExpenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate >= weekAgo && exp.priority === 'least_important';
                });
                if (luxuryExpenses.length === 0) {
                    challenge.progress = 7;
                } else {
                    const daysSinceStart = Math.floor((now - weekAgo) / (1000 * 60 * 60 * 24));
                    challenge.progress = Math.max(0, daysSinceStart - luxuryExpenses.length);
                }
            } else if (challenge.type === 'habit') {
                let daysTracked = 0;
                for (let i = 0; i < 7; i++) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    const dayExpenses = allExpenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate.toDateString() === date.toDateString();
                    });
                    if (dayExpenses.length > 0) daysTracked++;
                }
                challenge.progress = daysTracked;
            } else if (challenge.type === 'category') {
                const foodExpenses = allExpenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate >= weekAgo && exp.category.toLowerCase().includes('food');
                });
                const foodTotal = foodExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                if (foodTotal <= challenge.target) {
                    challenge.progress = challenge.target;
                } else {
                    challenge.progress = Math.max(0, challenge.target - (foodTotal - challenge.target));
                }
            } else if (challenge.type === 'monthly') {
                const monthlyBudget = allBudgets.find(b => b.timeframe === 'monthly');
                if (monthlyBudget) {
                    const monthlyExpenses = allExpenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate.getMonth() === now.getMonth() && expDate.getFullYear() === now.getFullYear();
                    });
                    const monthlyTotal = monthlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                    if (monthlyTotal <= monthlyBudget.amount) {
                        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                        const progress = (now.getDate() / daysInMonth) * 100;
                        challenge.progress = Math.floor(progress);
                    } else {
                        challenge.progress = 0;
                    }
                }
            }

            if (challenge.progress >= challenge.target && !challenge.completed) {
                challenge.completed = true;
                
                // ‚úÖ ENSURE userProfile exists
                if (!userProfile) {
                    userProfile = { xp: 0, level: 1, achievements: [], activeChallenges: [], streak: 0, challenges: [] };
                }
                
                // ‚úÖ ENSURE xp exists
                if (typeof userProfile.xp !== 'number') {
                    userProfile.xp = 0;
                }
                
                // ‚úÖ ADD XP
                const previousXP = userProfile.xp;
                userProfile.xp = userProfile.xp + challenge.reward;
                
                console.log(`‚úÖ Challenge Completed: ${challenge.name}!`);
                console.log(`   Previous XP: ${previousXP}, Reward: +${challenge.reward}, New XP: ${userProfile.xp}`);
                
                // ‚úÖ SAVE TO STORAGE
                saveUserProfile();
                console.log('‚úÖ Profile saved with new XP');
                
                showNotification(`üèÜ Challenge Completed: ${challenge.name}! +${challenge.reward} XP`, 'success');
                createConfetti(20);
                
                // ‚úÖ UPDATE UI IMMEDIATELY
                updateGamificationUI();
                console.log('‚úÖ UI Updated');
            }
        });

        saveUserProfile();
        renderChallenges();
        updateGamificationUI();
    }

    // ‚úÖ Helper function to get expenses from localStorage
    function getExpenses() {
        try {
            return JSON.parse(localStorage.getItem('expenses') || '[]');
        } catch (e) {
            console.error('Error parsing expenses:', e);
            return [];
        }
    }

    // ‚úÖ Helper function to get budgets from localStorage
    function getBudgets() {
        try {
            return JSON.parse(localStorage.getItem('budgets') || '[]');
        } catch (e) {
            console.error('Error parsing budgets:', e);
            return [];
        }
    }

    // ‚úÖ FIXED Budget Alert System with deduplication
    function checkBudgetAlerts(newExpense) {
        if (!allBudgets || allBudgets.length === 0) return;
        
        const now = new Date();
        const alerts = [];
        const shownAlertKeys = new Set(window.shownAlertKeys || []);
        
        allBudgets.forEach(budget => {
            let totalSpent = 0;
            let periodName = '';
            
            if (budget.timeframe === 'weekly') {
                const weekAgo = new Date(now);
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const weeklyExpenses = allExpenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    const matchesCategory = budget.category === 'General' || exp.category === budget.category;
                    return expDate >= weekAgo && matchesCategory;
                });
                
                totalSpent = weeklyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                periodName = 'Weekly';
                
            } else if (budget.timeframe === 'monthly') {
                const monthlyExpenses = allExpenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    const matchesCategory = budget.category === 'General' || exp.category === budget.category;
                    return expDate.getMonth() === now.getMonth() && 
                           expDate.getFullYear() === now.getFullYear() &&
                           matchesCategory;
                });
                
                totalSpent = monthlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                periodName = 'Monthly';
                
            } else if (budget.timeframe === 'yearly') {
                const yearlyExpenses = allExpenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    const matchesCategory = budget.category === 'General' || exp.category === budget.category;
                    return expDate.getFullYear() === now.getFullYear() && matchesCategory;
                });
                
                totalSpent = yearlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                periodName = 'Yearly';
            }
            
            const budgetAmount = parseFloat(budget.amount);
            const percentage = (totalSpent / budgetAmount) * 100;
            const alertKey = `${periodName}-${budget.category}-${Math.floor(percentage)}`;
            
            // Only show if not recently shown
            if (!shownAlertKeys.has(alertKey)) {
                if (totalSpent > budgetAmount) {
                    const overspend = totalSpent - budgetAmount;
                    alerts.push({
                        type: 'exceeded',
                        message: `üö® ${periodName} ${budget.category} Budget EXCEEDED!`,
                        details: `You've spent ‚Çπ${totalSpent.toFixed(2)} out of ‚Çπ${budgetAmount.toFixed(2)}. Over budget by ‚Çπ${overspend.toFixed(2)} (${percentage.toFixed(1)}%)`,
                        severity: 'danger',
                        key: alertKey
                    });
                } else if (percentage >= 90) {
                    const remaining = budgetAmount - totalSpent;
                    alerts.push({
                        type: 'warning',
                        message: `‚ö†Ô∏è ${periodName} ${budget.category} Budget Warning!`,
                        details: `You've used ${percentage.toFixed(1)}% of your budget. Only ‚Çπ${remaining.toFixed(2)} remaining!`,
                        severity: 'warning',
                        key: alertKey
                    });
                } else if (percentage >= 75) {
                    const remaining = budgetAmount - totalSpent;
                    alerts.push({
                        type: 'info',
                        message: `üí° ${periodName} ${budget.category} Budget Notice`,
                        details: `You've used ${percentage.toFixed(1)}% of your budget. ‚Çπ${remaining.toFixed(2)} remaining.`,
                        severity: 'info',
                        key: alertKey
                    });
                }
            }
        });
        
        // ‚úÖ SHOW ALERTS
        if (alerts.length > 0) {
            console.log('‚úÖ Showing', alerts.length, 'budget alerts');
            alerts.forEach((alert, index) => {
                setTimeout(() => {
                    showBudgetAlert(alert);
                    shownAlertKeys.add(alert.key);
                }, index * 400);
            });
            window.shownAlertKeys = shownAlertKeys;
        }
    }

    // ‚úÖ FIXED Budget Alert Display
    function showBudgetAlert(alert) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'budget-alert budget-alert-' + alert.severity;
        alertDiv.innerHTML = `
            <div class="alert-header">
                <strong>${alert.message}</strong>
                <button class="alert-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
            </div>
            <div class="alert-body">${alert.details}</div>
        `;
        
        let alertContainer = document.getElementById('alertContainer');
        if (!alertContainer) {
            alertContainer = document.createElement('div');
            alertContainer.id = 'alertContainer';
            alertContainer.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 9999;
                max-width: 400px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            `;
            document.body.appendChild(alertContainer);
        }
        
        alertContainer.appendChild(alertDiv);
        
        console.log('‚úÖ Alert displayed:', alert.message);
        
        // Auto-dismiss after 6 seconds
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 300);
            }
        }, 6000);
    }

    function updateDashboard() {
        try {
            updateStatistics();
            loadExpenses();
            loadBudgets();
            loadRecommendations();
            updateCharts();
            updateChallengeProgress();
        } catch (error) {
            console.error('Dashboard update error:', error);
        }
    }

    function updateStatistics() {
        const totalSpent = allExpenses.reduce((sum, exp) => sum + exp.amount, 0);
        document.getElementById('totalSpent').textContent = `‚Çπ${totalSpent.toFixed(2)}`;
        
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        const monthlyExpenses = allExpenses.filter(exp => {
            const expDate = new Date(exp.date);
            return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
        });
        const monthlySpent = monthlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
        document.getElementById('monthlySpent').textContent = `‚Çπ${monthlySpent.toFixed(2)}`;
        
        document.getElementById('transactionCount').textContent = allExpenses.length;
        
        const monthlyBudget = allBudgets.find(b => b.timeframe === 'monthly');
        const budgetLeftEl = document.getElementById('budgetLeft');
        
        if (monthlyBudget) {
            const budgetLeft = monthlyBudget.amount - monthlySpent;
            const percentage = (monthlySpent / monthlyBudget.amount) * 100;
            
            budgetLeftEl.textContent = `‚Çπ${budgetLeft.toFixed(2)}`;
            
            if (budgetLeft < 0) {
                budgetLeftEl.style.color = '#ef4444';
            } else if (percentage >= 90) {
                budgetLeftEl.style.color = '#f59e0b';
            } else {
                budgetLeftEl.style.color = '#10b981';
            }
        } else {
            budgetLeftEl.textContent = 'No Budget Set';
            budgetLeftEl.style.color = '#64748b';
        }
    }

    function loadExpenses() {
        const expenses = [...allExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));
        const expensesList = document.getElementById('expensesList');
        
        if (expenses.length === 0) {
            expensesList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No expenses yet. Start tracking!</p>';
            return;
        }
        
        expensesList.innerHTML = '';
        expenses.slice(0, 20).forEach(expense => {
            const card = document.createElement('div');
            card.className = 'expense-item';
            card.innerHTML = `
                <div class="expense-info">
                    <h3>${expense.description}</h3>
                    <div class="expense-meta">
                        ${expense.category} ‚Ä¢ ${new Date(expense.date).toLocaleDateString('en-IN')}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div class="expense-amount">‚Çπ${expense.amount.toFixed(2)}</div>
                    <span class="priority-badge priority-${expense.priority}">
                        ${expense.priority.replace(/_/g, ' ')}
                    </span>
                </div>
            `;
            expensesList.appendChild(card);
        });
    }

    function loadBudgets() {
        const budgetsList = document.getElementById('budgetsList');
        
        if (allBudgets.length === 0) {
            budgetsList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No budgets set. Create your first budget!</p>';
            return;
        }
        
        budgetsList.innerHTML = '';
        allBudgets.forEach(budget => {
            const card = document.createElement('div');
            card.className = 'budget-item';
            card.innerHTML = `
                <div class="budget-info">
                    <h3>${budget.category} - ${budget.timeframe}</h3>
                    <div class="budget-meta">Set on ${new Date(budget.createdAt).toLocaleDateString('en-IN')}</div>
                </div>
                <div class="expense-amount">‚Çπ${budget.amount.toFixed(2)}</div>
            `;
            budgetsList.appendChild(card);
        });
    }

    function loadRecommendations() {
        const recommendationsList = document.getElementById('recommendationsList');
        recommendationsList.innerHTML = '';
        
        const header = document.createElement('div');
        header.innerHTML = `
            <p style="color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6;">
                Our AI analyzes your spending patterns, predictions, and financial goals to provide personalized recommendations.
            </p>
        `;
        recommendationsList.appendChild(header);

        const predictiveEngine = new PredictiveEngine(allExpenses);
        const nextMonthPrediction = predictiveEngine.predictNextMonthSpending();
        const budgetPrediction = predictiveEngine.predictBudgetExceedance();
        const categorySpike = predictiveEngine.predictCategorySpike();
        
        const predictionInsights = [];

        const monthlyBudget = allBudgets.find(b => b.timeframe === 'monthly');
        if (monthlyBudget && budgetPrediction.predicted > monthlyBudget.amount) {
            const diff = budgetPrediction.predicted - monthlyBudget.amount;
            predictionInsights.push({
                icon: 'üö®',
                text: `<strong>Budget Alert:</strong> You are likely to exceed your monthly budget by about ‚Çπ${diff.toFixed(0)}. Consider reducing non-essential spending (Entertainment, Shopping) by 15‚Äì20%.`,
                savings: diff * 0.15,
                actionable: true,
                challengeId: 'weekly_budget',
                type: 'prediction'
            });
        }

        if (categorySpike) {
            predictionInsights.push({
                icon: '‚ö†Ô∏è',
                text: `<strong>Unusual Spending Detected:</strong> Your "${categorySpike.category}" expenses are ${((categorySpike.amount / categorySpike.average - 1) * 100).toFixed(0)}% higher than normal. Set a short-term cap for this category next week.`,
                savings: categorySpike.amount - categorySpike.average,
                actionable: false,
                type: 'prediction'
            });
        }

        if (nextMonthPrediction.trend === 'down' && budgetPrediction.current > 0) {
            const savings = budgetPrediction.current - nextMonthPrediction.predicted;
            if (savings > 0) {
                predictionInsights.push({
                    icon: 'üéâ',
                    text: `<strong>Great Progress!</strong> Your predicted spending is lower than this month. Redirect at least 20% of the saved amount (‚Çπ${(savings * 0.2).toFixed(0)}) into a savings goal or investment (SIP/PPF recommended).`,
                    savings: savings * 0.2,
                    actionable: true,
                    challengeId: 'save_1000',
                    type: 'prediction'
                });
            }
        } else if (nextMonthPrediction.trend === 'up' && nextMonthPrediction.predicted > 0) {
            predictionInsights.push({
                icon: 'üìà',
                text: `<strong>Upward Trend Alert:</strong> Your spending is trending upward. Review your "Least Important" expenses and try the "No Luxury Week" challenge to break this pattern.`,
                savings: 0,
                actionable: true,
                challengeId: 'no_luxury',
                type: 'prediction'
            });
        }

        if (budgetPrediction.dailyAverage > 0 && monthlyBudget) {
            const recommendedDaily = monthlyBudget.amount / 30;
            if (budgetPrediction.dailyAverage > recommendedDaily * 1.1) {
                predictionInsights.push({
                    icon: 'üí°',
                    text: `<strong>Daily Spending Tip:</strong> Your current daily average is ‚Çπ${budgetPrediction.dailyAverage.toFixed(0)}. Aim to reduce it to ‚Çπ${recommendedDaily.toFixed(0)}/day to stay on track.`,
                    savings: (budgetPrediction.dailyAverage - recommendedDaily) * budgetPrediction.daysRemaining,
                    actionable: false,
                    type: 'prediction'
                });
            }
        }

        const patternRecommendations = recommendationEngine.generateRecommendations(allExpenses, allBudgets);

        const allRecommendations = [...predictionInsights, ...patternRecommendations.map(rec => ({
            ...rec,
            type: 'pattern'
        }))];

        let lastType = null;
        allRecommendations.forEach((rec, index) => {
            if (rec.type !== lastType) {
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                sectionHeader.innerHTML = `
                    <h3>
                        ${rec.type === 'prediction' ? 'üîÆ Prediction-Based Insights' : 'üìä Pattern Analysis'}
                    </h3>
                `;
                recommendationsList.appendChild(sectionHeader);
                lastType = rec.type;
            }

            const card = document.createElement('div');
            card.className = 'recommendation-item';
            card.style.borderLeftColor = rec.type === 'prediction' ? '#8b5cf6' : '#6366f1';
            
            card.innerHTML = `
                <p style="display: flex; align-items: start; gap: 10px;">
                    <span style="font-size: 1.5em; flex-shrink: 0;">${rec.icon}</span>
                    <span style="flex: 1;">${rec.text}</span>
                </p>
                ${rec.savings > 0 ? `<span class="savings-badge">Potential Savings: ‚Çπ${rec.savings.toFixed(2)}</span>` : ''}
                ${rec.actionable && rec.challengeId ? 
                    `<button class="btn-insight-action" onclick="window.startChallenge('${rec.challengeId}')">
                        Start Challenge
                    </button>` : ''}
            `;
            recommendationsList.appendChild(card);
        });

        if (allRecommendations.length === 0) {
            const emptyCard = document.createElement('div');
            emptyCard.className = 'recommendation-item';
            emptyCard.innerHTML = `
                <p><span style="font-size: 1.5em; margin-right: 10px;">üìä</span>
                <strong>Get Started:</strong> Track your expenses consistently for 2‚Äì3 weeks to unlock deeper AI insights and more accurate predictions. The more data you provide, the smarter WealthWise AI becomes!</p>
            `;
            recommendationsList.appendChild(emptyCard);
        }

        const badge = document.getElementById('newRecommendationsBadge');
        if (badge && predictionInsights.length > 0) badge.style.display = 'block';
    }

    function renderPredictions() {
        const predictiveEngine = new PredictiveEngine(allExpenses);
        const container = document.getElementById('predictionsGrid');
        container.innerHTML = '';

        const nextMonthPrediction = predictiveEngine.predictNextMonthSpending();
        const predictionCard1 = document.createElement('div');
        predictionCard1.className = 'prediction-card';
        predictionCard1.innerHTML = `
            <h3>üìä Next Month Prediction</h3>
            <div class="prediction-value">‚Çπ${nextMonthPrediction.predicted.toFixed(2)}</div>
            <div class="prediction-insight">${nextMonthPrediction.insight}</div>
            <div class="prediction-trend ${nextMonthPrediction.trend === 'up' ? 'trend-up' : 'trend-down'}">
                ${nextMonthPrediction.trend === 'up' ? '‚Üë' : nextMonthPrediction.trend === 'down' ? '‚Üì' : '‚Üí'} 
                ${nextMonthPrediction.confidence}% confidence
            </div>
        `;
        container.appendChild(predictionCard1);

        const budgetPrediction = predictiveEngine.predictBudgetExceedance();
        const predictionCard2 = document.createElement('div');
        predictionCard2.className = 'prediction-card';
        predictionCard2.innerHTML = `
            <h3>üéØ Month-End Forecast</h3>
            <div class="prediction-value">‚Çπ${budgetPrediction.predicted.toFixed(2)}</div>
            <div class="prediction-insight">${budgetPrediction.insight}</div>
            <div class="prediction-trend">
                üìÖ ${budgetPrediction.daysRemaining} days remaining ‚Ä¢ ‚Çπ${budgetPrediction.dailyAverage.toFixed(0)}/day avg
            </div>
        `;
        container.appendChild(predictionCard2);

        const categorySpike = predictiveEngine.predictCategorySpike();
        if (categorySpike) {
            const predictionCard3 = document.createElement('div');
            predictionCard3.className = 'prediction-card';
            predictionCard3.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            predictionCard3.innerHTML = `
                <h3>‚ö†Ô∏è Unusual Spending Alert</h3>
                <div class="prediction-value">${categorySpike.category}</div>
                <div class="prediction-insight">${categorySpike.prediction}</div>
                <div class="prediction-trend trend-up">
                    High Risk ‚Ä¢ Review your ${categorySpike.category} expenses
                </div>
            `;
            container.appendChild(predictionCard3);
        }

        updatePredictionCharts();
    }

    function updatePredictionCharts() {
        updatePredictionChart();
        updatePatternChart();
    }

    function updatePredictionChart() {
        const ctx = document.getElementById('predictionChart');
        if (!ctx) return;
        
        if (predictionChart) predictionChart.destroy();

        const predictiveEngine = new PredictiveEngine(allExpenses);
        const last6Months = predictiveEngine.getLastNMonths(6);
        const nextMonthPrediction = predictiveEngine.predictNextMonthSpending();

        const labels = [];
        const actualData = [];
        const now = new Date();

        for (let i = 5; i >= 0; i--) {
            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
            labels.push(date.toLocaleDateString('en-IN', { month: 'short' }));
            actualData.push(last6Months[5 - i].total);
        }

        labels.push('Next Month');
        actualData.push(null);

        predictionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Actual Spending',
                    data: actualData.slice(0, -1).concat([last6Months[5].total]),
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }, {
                    label: 'Predicted',
                    data: [null, null, null, null, null, last6Months[5].total, nextMonthPrediction.predicted],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderDash: [5, 5],
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        position: 'bottom'
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ‚Çπ' + (context.parsed.y || 0).toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { 
                            callback: value => '‚Çπ' + value,
                            font: { size: 12 }
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 12 } }
                    }
                }
            }
        });
    }

    function updatePatternChart() {
        const ctx = document.getElementById('patternChart');
        if (!ctx) return;
        
        if (patternChart) patternChart.destroy();

        const dayPattern = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
        allExpenses.forEach(exp => {
            const day = new Date(exp.date).getDay();
            dayPattern[day] += exp.amount;
        });

        const dayLabels = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const dayData = dayLabels.map((_, i) => dayPattern[i]);

        patternChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dayLabels,
                datasets: [{
                    label: 'Average Spending by Day',
                    data: dayData,
                    backgroundColor: [
                        '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', 
                        '#10b981', '#3b82f6', '#ef4444'
                    ],
                    borderRadius: 10,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return 'Total: ‚Çπ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => '‚Çπ' + value,
                            font: { size: 12 }
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 12 } }
                    }
                }
            }
        });
    }

    function updateCharts() {
        updateExpenseChart(allExpenses);
        updateCategoryChart(allExpenses);
        updatePriorityChart(allExpenses);
    }

    function updateExpenseChart(expenses) {
        const ctx = document.getElementById('expenseChart');
        if (!ctx) return;
        
        if (expenseChart) expenseChart.destroy();
        
        const data = getTimeframeData(expenses, currentTimeframe);
        
        expenseChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Expenses',
                    data: data.values,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3,
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return 'Spent: ‚Çπ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { 
                            callback: value => '‚Çπ' + value,
                            font: { size: 12 }
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 12 } }
                    }
                }
            }
        });
    }

    function updateCategoryChart(expenses) {
        const ctx = document.getElementById('categoryChart');
        if (!ctx) return;
        
        if (categoryChart) categoryChart.destroy();
        
        const byCategory = {};
        expenses.forEach(exp => {
            byCategory[exp.category] = (byCategory[exp.category] || 0) + exp.amount;
        });
        
        const labels = Object.keys(byCategory);
        const values = Object.values(byCategory);
        
        if (labels.length === 0) {
            return;
        }
        
        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', 
                        '#10b981', '#3b82f6', '#ef4444', '#14b8a6', '#f97316'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff',
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 13 },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ‚Çπ' + value.toFixed(2) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    function updatePriorityChart(expenses) {
        const ctx = document.getElementById('priorityChart');
        if (!ctx) return;
        
        if (priorityChart) priorityChart.destroy();
        
        const byPriority = {
            'most_important': 0,
            'important': 0,
            'less_important': 0,
            'least_important': 0
        };
        
        expenses.forEach(exp => {
            if (byPriority.hasOwnProperty(exp.priority)) {
                byPriority[exp.priority] += exp.amount;
            }
        });
        
        priorityChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Most Important', 'Important', 'Less Important', 'Least Important'],
                datasets: [{
                    label: 'Amount Spent (‚Çπ)',
                    data: Object.values(byPriority),
                    backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#ef4444'],
                    borderRadius: 10,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return 'Spent: ‚Çπ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => '‚Çπ' + value,
                            font: { size: 12 }
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 12 } }
                    }
                }
            }
        });
    }

    function getTimeframeData(expenses, timeframe) {
        const now = new Date();
        
        if (timeframe === 'weekly') {
            const labels = [];
            const values = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                labels.push(dateStr);
                
                const dayExpenses = expenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.toDateString() === date.toDateString();
                });
                
                values.push(dayExpenses.reduce((sum, exp) => sum + exp.amount, 0));
            }
            
            return { labels, values };
            
        } else if (timeframe === 'monthly') {
            const labels = [];
            const values = [];
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now);
                date.setMonth(date.getMonth() - i);
                const monthStr = date.toLocaleDateString('en-IN', { month: 'short' });
                labels.push(monthStr);
                
                const monthExpenses = expenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getMonth() === date.getMonth() && expDate.getFullYear() === date.getFullYear();
                });
                
                values.push(monthExpenses.reduce((sum, exp) => sum + exp.amount, 0));
            }
            
            return { labels, values };
            
        } else if (timeframe === 'yearly') {
            const labels = [];
            const values = [];
            
            for (let i = 4; i >= 0; i--) {
                const year = now.getFullYear() - i;
                labels.push(year.toString());
                
                const yearExpenses = expenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getFullYear() === year;
                });
                
                values.push(yearExpenses.reduce((sum, exp) => sum + exp.amount, 0));
            }
            
            return { labels, values };
        }
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 10000;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            text-align: center;
        `;
        
        if (type === 'success') {
            notification.style.background = '#10b981';
            notification.style.color = 'white';
        } else if (type === 'error') {
            notification.style.background = '#ef4444';
            notification.style.color = 'white';
        } else {
            notification.style.background = '#3b82f6';
            notification.style.color = 'white';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Auto-dismiss after 3 seconds
        const dismissTimeout = setTimeout(() => {
            if (notification.parentElement) {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 3000);
        
        // Allow manual click to dismiss
        notification.style.cursor = 'pointer';
        notification.addEventListener('click', () => {
            clearTimeout(dismissTimeout);
            if (notification.parentElement) {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        });
    }

    function logout() {
        signOut(auth).then(() => {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        });
    }
</script>
</body>
</html>

